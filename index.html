<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>Freediving Tracker â€” Ğ¡Ñ‚Ğ°Ğ½Ñ–ÑĞ»Ğ°Ğ²</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#050d1a;font-family:Georgia,serif;color:#e2e8f0;overflow-x:hidden}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// â”€â”€â”€ FIT PARSER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FIT_EPOCH = 631065600;
function parseFitFile(buffer) {
  try {
    const b = new Uint8Array(buffer), v = new DataView(buffer);
    if (b.length < 14) return null;
    const hSize = b[0];
    if (String.fromCharCode(b[8],b[9],b[10],b[11]) !== '.FIT') return null;
    const dataSize = v.getUint32(4, true);
    const end = Math.min(hSize + dataSize, b.length - 2);
    let off = hSize, defs = {}, pts = [], maxHR=0, minHR=255, sumHR=0, nHR=0;
    while (off < end) {
      if (off >= b.length) break;
      const h = b[off++];
      if (h & 0x80) continue;
      const isDef = !!(h & 0x40), hasDev = !!(h & 0x20), lt = h & 0x0F;
      if (isDef) {
        if (off+5 > b.length) break;
        off++;
        const le = b[off++] === 0;
        const mn = le ? v.getUint16(off,true) : v.getUint16(off,false); off+=2;
        const nf = b[off++];
        const fields = [];
        for (let i=0; i<nf && off+3<=b.length; i++) { fields.push({n:b[off],sz:b[off+1]}); off+=3; }
        if (hasDev && off<b.length) { const nd=b[off++]; off+=nd*3; }
        defs[lt] = {mn, fields, le};
      } else {
        const d = defs[lt]; if (!d) break;
        const sz = d.fields.reduce((a,f) => a+f.sz, 0);
        if (off+sz > b.length) break;
        const msg = {}; let fo = off;
        for (const f of d.fields) {
          try {
            if(f.sz===1) msg[f.n]=b[fo];
            else if(f.sz===2) msg[f.n]=d.le?v.getUint16(fo,true):v.getUint16(fo,false);
            else if(f.sz===4) msg[f.n]=d.le?v.getUint32(fo,true):v.getUint32(fo,false);
          } catch(e) {}
          fo += f.sz;
        }
        off = fo;
        if (d.mn === 20) {
          const hr=msg[3], ts=msg[253];
          if (hr && hr>0 && hr<250 && ts) {
            pts.push({t:ts+FIT_EPOCH, hr});
            sumHR+=hr; nHR++;
            if(hr>maxHR) maxHR=hr;
            if(hr<minHR) minHR=hr;
          }
        }
      }
    }
    if (pts.length>0) { const t0=pts[0].t; pts.forEach(p => p.el=p.t-t0); }
    return { pts, stats: { avg:nHR?Math.round(sumHR/nHR):0, max:maxHR<250?maxHR:0, min:minHR<250&&minHR>0?minHR:0, dur:pts.length>1?Math.round(pts[pts.length-1].el/60):0, n:nHR }};
  } catch(e) { return null; }
}

// â”€â”€â”€ DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PHASES = [
  {id:1, name:"Ğ¤Ğ°Ğ·Ğ° 1", subtitle:"Ğ’Ñ–Ğ´Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ", color:"#4ade80", rgb:"74,222,128",  weeks:[1,2,3,4]},
  {id:2, name:"Ğ¤Ğ°Ğ·Ğ° 2", subtitle:"Ğ Ğ¾Ğ·Ğ²Ğ¸Ñ‚Ğ¾Ğº",    color:"#38bdf8", rgb:"56,189,248",  weeks:[5,6,7,8]},
  {id:3, name:"Ğ¤Ğ°Ğ·Ğ° 3", subtitle:"ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑ",     color:"#a78bfa", rgb:"167,139,250", weeks:[9,10,11,12]}
];
const BASE_PLANS = {
  1:{phase:1,goals:{s:"1.5 Ñ…Ğ²",d:"4Ã—25Ğ¼ DNF",g:"4 ÑĞ¿ÑƒÑĞºĞ¸"},tip:"ĞŸĞµÑ€ÑˆĞµ Ğ·Ğ°Ğ½ÑÑ‚Ñ‚Ñ Ğ¿Ñ–ÑĞ»Ñ Ğ¿ĞµÑ€ĞµÑ€Ğ²Ğ¸. ĞÑ–ÑĞºĞ¾Ğ³Ğ¾ Ñ„Ğ¾Ñ€ÑÑƒĞ²Ğ°Ğ½Ğ½Ñ.",blocks:[{n:"Ğ Ğ¾Ğ·Ğ¼Ğ¸Ğ½ĞºĞ°",t:"10 Ñ…Ğ²",d:"6Ã—25Ğ¼ ÑĞ¿Ğ¾ĞºÑ–Ğ¹Ğ½Ğ¸Ğ¹ ĞºÑ€Ğ¾Ğ»ÑŒ, Ñ€Ğ¾Ğ·Ñ‚ÑĞ¶ĞºĞ°, Ğ´Ñ–Ğ°Ñ„Ñ€Ğ°Ğ³Ğ¼Ğ°Ğ»ÑŒĞ½Ğµ Ğ´Ğ¸Ñ…Ğ°Ğ½Ğ½Ñ."},{n:"Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ĞºĞ° Ğ½Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ½Ñ–",t:"15 Ñ…Ğ²",d:"4 Ğ¿Ñ–Ğ´Ñ…Ğ¾Ğ´Ğ¸ Ã— 1.5 Ñ…Ğ². Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 3 Ñ…Ğ² Ğ¼Ñ–Ğ¶ Ğ¿Ñ–Ğ´Ñ…Ğ¾Ğ´Ğ°Ğ¼Ğ¸."},{n:"Ğ”Ğ¸Ğ½Ğ°Ğ¼Ñ–ĞºĞ° Ğ±ĞµĞ· Ğ»Ğ°ÑÑ‚ (DNF)",t:"20 Ñ…Ğ²",d:"4Ã—25Ğ¼ Ğ±ĞµĞ· Ğ»Ğ°ÑÑ‚. Ğ¢ĞµĞ¼Ğ¿ Ğ¿Ğ¾Ğ²Ñ–Ğ»ÑŒĞ½Ğ¸Ğ¹. Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 4 Ñ…Ğ²."},{n:"Ğ“Ğ»Ğ¸Ğ±Ğ¸Ğ½Ğ°",t:"10 Ñ…Ğ²",d:"4 ÑĞ¿ÑƒÑĞºĞ¸ Ğ´Ğ¾ 3.8Ğ¼ Ñ– Ğ¾Ğ´Ñ€Ğ°Ğ·Ñƒ Ğ²Ğ³Ğ¾Ñ€Ñƒ. ĞŸÑ€Ğ¾Ğ´ÑƒĞ²ĞºĞ° ĞºĞ¾Ğ¶Ğ½Ñ– 50ÑĞ¼. Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 3 Ñ…Ğ²."},{n:"Ğ—Ğ°Ğ¼Ğ¸Ğ½ĞºĞ°",t:"5 Ñ…Ğ²",d:"2Ã—25Ğ¼ ÑĞ¿Ğ¾ĞºÑ–Ğ¹Ğ½Ğµ Ğ¿Ğ»Ğ°Ğ²Ğ°Ğ½Ğ½Ñ. Ğ”Ğ¸Ñ…Ğ°Ğ½Ğ½Ñ Ğ½Ğ° Ğ±Ğ¾Ñ€Ñ‚Ğ¸ĞºÑƒ."}]},
  2:{phase:1,goals:{s:"2 Ñ…Ğ²",d:"4Ã—25Ğ¼ DNF",g:"4 ÑĞ¿ÑƒÑĞºĞ¸, 10-15 ÑĞµĞº"},tip:"ĞŸÑ€Ğ°ĞºÑ‚Ğ¸ĞºÑƒĞ¹ Ğ¤Ñ€ĞµĞ½Ğ·ĞµĞ»ÑŒ Ñ‰Ğ¾Ğ´Ğ½Ñ 5 Ñ…Ğ²Ğ¸Ğ»Ğ¸Ğ½.",blocks:[{n:"Ğ Ğ¾Ğ·Ğ¼Ğ¸Ğ½ĞºĞ°",t:"10 Ñ…Ğ²",d:"6Ã—25Ğ¼ ĞºÑ€Ğ¾Ğ»ÑŒ, Ñ€Ğ¾Ğ·Ñ‚ÑĞ¶ĞºĞ°."},{n:"Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ĞºĞ° Ğ½Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ½Ñ–",t:"15 Ñ…Ğ²",d:"4 Ğ¿Ñ–Ğ´Ñ…Ğ¾Ğ´Ğ¸ Ã— 2 Ñ…Ğ². Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 3 Ñ…Ğ²."},{n:"Ğ”Ğ¸Ğ½Ğ°Ğ¼Ñ–ĞºĞ° Ğ±ĞµĞ· Ğ»Ğ°ÑÑ‚ (DNF)",t:"20 Ñ…Ğ²",d:"4Ã—25Ğ¼ Ğ±ĞµĞ· Ğ»Ğ°ÑÑ‚. Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 4 Ñ…Ğ²."},{n:"Ğ“Ğ»Ğ¸Ğ±Ğ¸Ğ½Ğ°",t:"10 Ñ…Ğ²",d:"4 ÑĞ¿ÑƒÑĞºĞ¸ â€” 10-15 ÑĞµĞº Ğ½Ğ° Ğ´Ğ½Ñ–. Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 3 Ñ…Ğ²."},{n:"Ğ—Ğ°Ğ¼Ğ¸Ğ½ĞºĞ°",t:"5 Ñ…Ğ²",d:"2Ã—25Ğ¼ ÑĞ¿Ğ¾ĞºÑ–Ğ¹Ğ½Ğµ Ğ¿Ğ»Ğ°Ğ²Ğ°Ğ½Ğ½Ñ."}]},
  3:{phase:1,goals:{s:"2.5 Ñ…Ğ²",d:"4Ã—25Ğ¼ Ğ°Ğ±Ğ¾ 1Ã—50Ğ¼ DNF",g:"4 ÑĞ¿ÑƒÑĞºĞ¸, 20-30 ÑĞµĞº"},tip:"50Ğ¼ â€” Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ ÑĞºÑ‰Ğ¾ ÑĞ²Ñ–Ğ¶Ğ¸Ğ¹ Ñ– Ğ¿ÑƒĞ»ÑŒÑ < 90.",blocks:[{n:"Ğ Ğ¾Ğ·Ğ¼Ğ¸Ğ½ĞºĞ°",t:"10 Ñ…Ğ²",d:"6Ã—25Ğ¼ ĞºÑ€Ğ¾Ğ»ÑŒ, Ñ€Ğ¾Ğ·Ñ‚ÑĞ¶ĞºĞ°."},{n:"Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ĞºĞ° Ğ½Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ½Ñ–",t:"15 Ñ…Ğ²",d:"4 Ğ¿Ñ–Ğ´Ñ…Ğ¾Ğ´Ğ¸ Ã— 2-2.5 Ñ…Ğ². Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 3 Ñ…Ğ²."},{n:"Ğ”Ğ¸Ğ½Ğ°Ğ¼Ñ–ĞºĞ° Ğ±ĞµĞ· Ğ»Ğ°ÑÑ‚ (DNF)",t:"20 Ñ…Ğ²",d:"4Ã—25Ğ¼. Ğ¯ĞºÑ‰Ğ¾ Ğ»ĞµĞ³ĞºĞ¾ â€” ÑĞ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ 50Ğ¼. Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 4 Ñ…Ğ²."},{n:"Ğ“Ğ»Ğ¸Ğ±Ğ¸Ğ½Ğ°",t:"10 Ñ…Ğ²",d:"4 ÑĞ¿ÑƒÑĞºĞ¸, 20-30 ÑĞµĞº Ğ½Ğ° Ğ´Ğ½Ñ–. Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 3-4 Ñ…Ğ²."},{n:"Ğ—Ğ°Ğ¼Ğ¸Ğ½ĞºĞ°",t:"5 Ñ…Ğ²",d:"2Ã—25Ğ¼ ÑĞ¿Ğ¾ĞºÑ–Ğ¹Ğ½Ğµ Ğ¿Ğ»Ğ°Ğ²Ğ°Ğ½Ğ½Ñ."}]},
  4:{phase:1,goals:{s:"2.5 Ñ…Ğ²",d:"5Ã—25Ğ¼ Ğ°Ğ±Ğ¾ 2Ã—50Ğ¼ DNF",g:"5 ÑĞ¿ÑƒÑĞºÑ–Ğ², 30-45 ÑĞµĞº"},tip:"ĞšÑ–Ğ½ĞµÑ†ÑŒ Ğ¤Ğ°Ğ·Ğ¸ 1!",blocks:[{n:"Ğ Ğ¾Ğ·Ğ¼Ğ¸Ğ½ĞºĞ°",t:"10 Ñ…Ğ²",d:"6Ã—25Ğ¼ ĞºÑ€Ğ¾Ğ»ÑŒ."},{n:"Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ĞºĞ° Ğ½Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ½Ñ–",t:"15 Ñ…Ğ²",d:"4 Ğ¿Ñ–Ğ´Ñ…Ğ¾Ğ´Ğ¸ Ã— 2.5 Ñ…Ğ². Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 3 Ñ…Ğ²."},{n:"Ğ”Ğ¸Ğ½Ğ°Ğ¼Ñ–ĞºĞ° Ğ±ĞµĞ· Ğ»Ğ°ÑÑ‚ (DNF)",t:"20 Ñ…Ğ²",d:"5Ã—25Ğ¼ Ğ°Ğ±Ğ¾ 2Ã—50Ğ¼. Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 4 Ñ…Ğ²."},{n:"Ğ“Ğ»Ğ¸Ğ±Ğ¸Ğ½Ğ°",t:"10 Ñ…Ğ²",d:"5 ÑĞ¿ÑƒÑĞºÑ–Ğ², 30-45 ÑĞµĞº + Ğ³Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒ. Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 4 Ñ…Ğ²."},{n:"Ğ—Ğ°Ğ¼Ğ¸Ğ½ĞºĞ°",t:"5 Ñ…Ğ²",d:"2Ã—25Ğ¼."}]},
  5:{phase:2,goals:{s:"3 Ñ…Ğ²",d:"4Ã—50Ğ¼ DYN Ğ· Ğ»Ğ°ÑÑ‚Ğ°Ğ¼Ğ¸",g:"4 ÑĞ¿ÑƒÑĞºĞ¸, 45-60 ÑĞµĞº"},tip:"ĞŸĞµÑ€ÑˆĞ¸Ğ¹ Ñ€Ğ°Ğ· Ğ· Ğ»Ğ°ÑÑ‚Ğ°Ğ¼Ğ¸. Ğ ÑƒÑ… Ğ²Ñ–Ğ´ ÑÑ‚ĞµĞ³Ğ½Ğ°.",blocks:[{n:"Ğ Ğ¾Ğ·Ğ¼Ğ¸Ğ½ĞºĞ°",t:"10 Ñ…Ğ²",d:"6Ã—25Ğ¼ ĞºÑ€Ğ¾Ğ»ÑŒ."},{n:"Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ĞºĞ° Ğ½Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ½Ñ–",t:"15 Ñ…Ğ²",d:"3 Ğ¿Ñ–Ğ´Ñ…Ğ¾Ğ´Ğ¸ Ã— 3 Ñ…Ğ². Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 3.5 Ñ…Ğ²."},{n:"Ğ”Ğ¸Ğ½Ğ°Ğ¼Ñ–ĞºĞ° Ğ· Ğ»Ğ°ÑÑ‚Ğ°Ğ¼Ğ¸ (DYN)",t:"20 Ñ…Ğ²",d:"4Ã—50Ğ¼ Ğ· Ğ»Ğ°ÑÑ‚Ğ°Ğ¼Ğ¸, Ğ¿Ğ¾ÑÑ 2ĞºĞ³. Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 5 Ñ…Ğ²."},{n:"Ğ“Ğ»Ğ¸Ğ±Ğ¸Ğ½Ğ°",t:"10 Ñ…Ğ²",d:"4 ÑĞ¿ÑƒÑĞºĞ¸, 45-60 ÑĞµĞº + Ğ³Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒ. Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 4 Ñ…Ğ²."},{n:"Ğ—Ğ°Ğ¼Ğ¸Ğ½ĞºĞ°",t:"5 Ñ…Ğ²",d:"2Ã—25Ğ¼."}]},
  6:{phase:2,goals:{s:"3 Ñ…Ğ²",d:"4Ã—50Ğ¼ DYN",g:"4 ÑĞ¿ÑƒÑĞºĞ¸, 45-60 ÑĞµĞº"},tip:"Ğ—Ğ°ĞºÑ€Ñ–Ğ¿Ğ»ĞµĞ½Ğ½Ñ Ñ‚Ğ¸Ğ¶Ğ½Ñ 5.",blocks:[{n:"Ğ Ğ¾Ğ·Ğ¼Ğ¸Ğ½ĞºĞ°",t:"10 Ñ…Ğ²",d:"6Ã—25Ğ¼ ĞºÑ€Ğ¾Ğ»ÑŒ."},{n:"Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ĞºĞ° Ğ½Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ½Ñ–",t:"15 Ñ…Ğ²",d:"3 Ğ¿Ñ–Ğ´Ñ…Ğ¾Ğ´Ğ¸ Ã— 3 Ñ…Ğ². Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 3.5 Ñ…Ğ²."},{n:"Ğ”Ğ¸Ğ½Ğ°Ğ¼Ñ–ĞºĞ° Ğ· Ğ»Ğ°ÑÑ‚Ğ°Ğ¼Ğ¸ (DYN)",t:"20 Ñ…Ğ²",d:"4Ã—50Ğ¼. Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 5 Ñ…Ğ²."},{n:"Ğ“Ğ»Ğ¸Ğ±Ğ¸Ğ½Ğ°",t:"10 Ñ…Ğ²",d:"4 ÑĞ¿ÑƒÑĞºĞ¸, 45-60 ÑĞµĞº + Ğ³Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒ. Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 4 Ñ…Ğ²."},{n:"Ğ—Ğ°Ğ¼Ğ¸Ğ½ĞºĞ°",t:"5 Ñ…Ğ²",d:"2Ã—25Ğ¼."}]},
  7:{phase:2,goals:{s:"3.5 Ñ…Ğ²",d:"3Ã—75Ğ¼ Ğ°Ğ±Ğ¾ 4Ã—50Ğ¼ DYN",g:"4 ÑĞ¿ÑƒÑĞºĞ¸ ĞºĞ¾Ğ¼Ğ±Ğ¾"},tip:"ĞŸĞµÑ€ÑˆĞ° ÑĞ¿Ñ€Ğ¾Ğ±Ğ° 75Ğ¼!",blocks:[{n:"Ğ Ğ¾Ğ·Ğ¼Ğ¸Ğ½ĞºĞ°",t:"10 Ñ…Ğ²",d:"6Ã—25Ğ¼ ĞºÑ€Ğ¾Ğ»ÑŒ."},{n:"Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ĞºĞ° Ğ½Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ½Ñ–",t:"15 Ñ…Ğ²",d:"3 Ğ¿Ñ–Ğ´Ñ…Ğ¾Ğ´Ğ¸ Ã— 3-3.5 Ñ…Ğ². Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 4 Ñ…Ğ²."},{n:"Ğ”Ğ¸Ğ½Ğ°Ğ¼Ñ–ĞºĞ° Ğ· Ğ»Ğ°ÑÑ‚Ğ°Ğ¼Ğ¸ (DYN)",t:"20 Ñ…Ğ²",d:"3Ã—75Ğ¼ Ğ°Ğ±Ğ¾ 4Ã—50Ğ¼. Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 5-6 Ñ…Ğ²."},{n:"Ğ“Ğ»Ğ¸Ğ±Ğ¸Ğ½Ğ°",t:"10 Ñ…Ğ²",d:"4 ÑĞ¿ÑƒÑĞºĞ¸: ÑÑ‚Ğ°Ñ‚Ğ¸ĞºĞ° 30-45 ÑĞµĞº + Ğ³Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒ. Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 4 Ñ…Ğ²."},{n:"Ğ—Ğ°Ğ¼Ğ¸Ğ½ĞºĞ°",t:"5 Ñ…Ğ²",d:"2Ã—25Ğ¼."}]},
  8:{phase:2,goals:{s:"3.5 Ñ…Ğ²",d:"3Ã—75Ğ¼ DYN",g:"4 ÑĞ¿ÑƒÑĞºĞ¸ ĞºĞ¾Ğ¼Ğ±Ğ¾"},tip:"ĞšÑ–Ğ½ĞµÑ†ÑŒ Ğ¤Ğ°Ğ·Ğ¸ 2. Ğ ĞµĞºĞ¾Ñ€Ğ´ 75Ğ¼ Ğ¿Ğ¾Ñ€ÑƒÑ‡!",blocks:[{n:"Ğ Ğ¾Ğ·Ğ¼Ğ¸Ğ½ĞºĞ°",t:"10 Ñ…Ğ²",d:"6Ã—25Ğ¼ ĞºÑ€Ğ¾Ğ»ÑŒ."},{n:"Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ĞºĞ° Ğ½Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ½Ñ–",t:"15 Ñ…Ğ²",d:"3 Ğ¿Ñ–Ğ´Ñ…Ğ¾Ğ´Ğ¸ Ã— 3.5 Ñ…Ğ². Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 4 Ñ…Ğ²."},{n:"Ğ”Ğ¸Ğ½Ğ°Ğ¼Ñ–ĞºĞ° Ğ· Ğ»Ğ°ÑÑ‚Ğ°Ğ¼Ğ¸ (DYN)",t:"20 Ñ…Ğ²",d:"3Ã—75Ğ¼. Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 6 Ñ…Ğ²."},{n:"Ğ“Ğ»Ğ¸Ğ±Ğ¸Ğ½Ğ°",t:"10 Ñ…Ğ²",d:"4 ÑĞ¿ÑƒÑĞºĞ¸ ĞºĞ¾Ğ¼Ğ±Ğ¾."},{n:"Ğ—Ğ°Ğ¼Ğ¸Ğ½ĞºĞ°",t:"5 Ñ…Ğ²",d:"2Ã—25Ğ¼."}]},
  9:{phase:3,goals:{s:"4 Ñ…Ğ²",d:"3Ã—75Ğ¼ Ğ°Ğ±Ğ¾ 2Ã—100Ğ¼ DYN",g:"4 ÑĞ¿ÑƒÑĞºĞ¸"},tip:"Ğ¤Ğ°Ğ·Ğ° 3 â€” Ñ„Ñ–Ğ½Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ÑĞ¿Ñ€Ğ¸Ğ½Ñ‚!",blocks:[{n:"Ğ Ğ¾Ğ·Ğ¼Ğ¸Ğ½ĞºĞ°",t:"10 Ñ…Ğ²",d:"6Ã—25Ğ¼ ĞºÑ€Ğ¾Ğ»ÑŒ."},{n:"Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ĞºĞ° Ğ½Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ½Ñ–",t:"15 Ñ…Ğ²",d:"3 Ğ¿Ñ–Ğ´Ñ…Ğ¾Ğ´Ğ¸ Ã— 3.5-4 Ñ…Ğ². Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 4 Ñ…Ğ²."},{n:"Ğ”Ğ¸Ğ½Ğ°Ğ¼Ñ–ĞºĞ° Ğ· Ğ»Ğ°ÑÑ‚Ğ°Ğ¼Ğ¸ (DYN)",t:"20 Ñ…Ğ²",d:"3Ã—75Ğ¼ Ğ°Ğ±Ğ¾ 2Ã—100Ğ¼. Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 6 Ñ…Ğ²."},{n:"Ğ“Ğ»Ğ¸Ğ±Ğ¸Ğ½Ğ°",t:"10 Ñ…Ğ²",d:"4 ÑĞ¿ÑƒÑĞºĞ¸ Ğ²Ñ–Ğ»ÑŒĞ½Ğ¸Ğ¹ ÑÑ‚Ğ¸Ğ»ÑŒ."},{n:"Ğ—Ğ°Ğ¼Ğ¸Ğ½ĞºĞ°",t:"5 Ñ…Ğ²",d:"2Ã—25Ğ¼."}]},
  10:{phase:3,goals:{s:"4 Ñ…Ğ²",d:"2Ã—100Ğ¼ DYN",g:"3 ÑĞ¿ÑƒÑĞºĞ¸"},tip:"100Ğ¼ Ğ»ĞµĞ³ĞºĞ¾ â€” Ñ‚Ğ¸ Ğ²Ğ¶Ğµ Ğ¿ĞµÑ€ĞµĞ²ĞµÑ€ÑˆĞ¸Ğ² Ñ€ĞµĞºĞ¾Ñ€Ğ´!",blocks:[{n:"Ğ Ğ¾Ğ·Ğ¼Ğ¸Ğ½ĞºĞ°",t:"10 Ñ…Ğ²",d:"6Ã—25Ğ¼ ĞºÑ€Ğ¾Ğ»ÑŒ."},{n:"Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ĞºĞ° Ğ½Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ½Ñ–",t:"15 Ñ…Ğ²",d:"3 Ğ¿Ñ–Ğ´Ñ…Ğ¾Ğ´Ğ¸ Ã— 4 Ñ…Ğ². Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 4 Ñ…Ğ²."},{n:"Ğ”Ğ¸Ğ½Ğ°Ğ¼Ñ–ĞºĞ° Ğ· Ğ»Ğ°ÑÑ‚Ğ°Ğ¼Ğ¸ (DYN)",t:"20 Ñ…Ğ²",d:"2Ã—100Ğ¼. Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 6 Ñ…Ğ²."},{n:"Ğ“Ğ»Ğ¸Ğ±Ğ¸Ğ½Ğ°",t:"10 Ñ…Ğ²",d:"3 ÑĞ¿ÑƒÑĞºĞ¸ Ğ²Ñ–Ğ´Ğ½Ğ¾Ğ²Ğ»ÑĞ²Ğ°Ğ»ÑŒĞ½Ñ–."},{n:"Ğ—Ğ°Ğ¼Ğ¸Ğ½ĞºĞ°",t:"5 Ñ…Ğ²",d:"2Ã—25Ğ¼."}]},
  11:{phase:3,goals:{s:"4+ Ñ…Ğ²",d:"Ğ¡Ğ¿Ñ€Ğ¾Ğ±Ğ° Ñ€ĞµĞºĞ¾Ñ€Ğ´Ñƒ",g:"3 ÑĞ¿ÑƒÑĞºĞ¸"},tip:"Ğ”ĞµĞ½ÑŒ Ñ€ĞµĞºĞ¾Ñ€Ğ´Ñƒ! Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½ÑŒ Ğ´Ğ¾Ğ±Ñ€Ğµ.",blocks:[{n:"Ğ Ğ¾Ğ·Ğ¼Ğ¸Ğ½ĞºĞ°",t:"10 Ñ…Ğ²",d:"6Ã—25Ğ¼ ĞºÑ€Ğ¾Ğ»ÑŒ."},{n:"Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ĞºĞ° Ğ½Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ½Ñ–",t:"15 Ñ…Ğ²",d:"3 Ğ¿Ñ–Ğ´Ñ…Ğ¾Ğ´Ğ¸ Ã— 4+ Ñ…Ğ². Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 4-5 Ñ…Ğ²."},{n:"Ğ¡Ğ¿Ñ€Ğ¾Ğ±Ğ° Ñ€ĞµĞºĞ¾Ñ€Ğ´Ñƒ Ğ´Ğ¸ÑÑ‚Ğ°Ğ½Ñ†Ñ–Ñ—",t:"20 Ñ…Ğ²",d:"1 ÑĞ¿Ñ€Ğ¾Ğ±Ğ° Ñ€ĞµĞºĞ¾Ñ€Ğ´Ñƒ Ğ¿Ñ–ÑĞ»Ñ 5-6 Ñ…Ğ² Ğ²Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½ĞºÑƒ."},{n:"Ğ“Ğ»Ğ¸Ğ±Ğ¸Ğ½Ğ°",t:"10 Ñ…Ğ²",d:"3 ÑĞ¿ÑƒÑĞºĞ¸ Ğ²Ñ–Ğ´Ğ½Ğ¾Ğ²Ğ»ÑĞ²Ğ°Ğ»ÑŒĞ½Ñ–."},{n:"Ğ—Ğ°Ğ¼Ğ¸Ğ½ĞºĞ°",t:"5 Ñ…Ğ²",d:"2Ã—25Ğ¼."}]},
  12:{phase:3,goals:{s:"4+ Ñ…Ğ²",d:"ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ€ĞµĞºĞ¾Ñ€Ğ´",g:"3 ÑĞ¿ÑƒÑĞºĞ¸"},tip:"Ğ¤Ñ–Ğ½Ğ°Ğ» Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¸! ğŸ‰",blocks:[{n:"Ğ Ğ¾Ğ·Ğ¼Ğ¸Ğ½ĞºĞ°",t:"10 Ñ…Ğ²",d:"6Ã—25Ğ¼ ĞºÑ€Ğ¾Ğ»ÑŒ."},{n:"Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ĞºĞ° Ğ½Ğ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ½Ñ–",t:"15 Ñ…Ğ²",d:"3 Ğ¿Ñ–Ğ´Ñ…Ğ¾Ğ´Ğ¸ Ã— 4+ Ñ…Ğ². Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº 4-5 Ñ…Ğ²."},{n:"Ğ¤Ñ–Ğ½Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ Ğ·Ğ°Ğ¿Ğ»Ğ¸Ğ²",t:"20 Ñ…Ğ²",d:"1 ÑĞ¿Ñ€Ğ¾Ğ±Ğ° Ñ€ĞµĞºĞ¾Ñ€Ğ´Ñƒ. Ğ¡Ğ²ÑÑ‚ĞºÑƒĞ¹ ĞºĞ¾Ğ¶ĞµĞ½ Ğ¼ĞµÑ‚Ñ€ Ğ¿Ğ¾Ğ½Ğ°Ğ´ 75Ğ¼!"},{n:"Ğ“Ğ»Ğ¸Ğ±Ğ¸Ğ½Ğ°",t:"10 Ñ…Ğ²",d:"3 ÑĞ¿ÑƒÑĞºĞ¸ â€” Ğ½Ğ°ÑĞ¾Ğ»Ğ¾Ğ´Ğ¶ÑƒĞ¹ÑÑ."},{n:"Ğ—Ğ°Ğ¼Ğ¸Ğ½ĞºĞ°",t:"5 Ñ…Ğ²",d:"2Ã—25Ğ¼."}]}
};

// â”€â”€â”€ ACHIEVEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ACH_DEFS = [
  {id:"h45",  icon:"ğŸ’§", name:"45 ÑĞµĞºÑƒĞ½Ğ´",       desc:"â‰¥0:45 Ğ·Ğ°Ñ‚Ñ€Ğ¸Ğ¼ĞºĞ¸. ĞšĞ¾Ğ¶Ğ½Ğ° ÑĞ¿Ñ€Ğ¾Ğ±Ğ° Ñ€Ğ°Ñ…ÑƒÑ”Ñ‚ÑŒÑÑ",      type:"timer", thr:45},
  {id:"h60",  icon:"â±",  name:"Ğ¥Ğ²Ğ¸Ğ»Ğ¸Ğ½Ğ°",         desc:"â‰¥1:00 Ğ·Ğ°Ñ‚Ñ€Ğ¸Ğ¼ĞºĞ¸. ĞšĞ¾Ğ¶Ğ½Ğ° ÑĞ¿Ñ€Ğ¾Ğ±Ğ° Ñ€Ğ°Ñ…ÑƒÑ”Ñ‚ÑŒÑÑ",      type:"timer", thr:60},
  {id:"h90",  icon:"ğŸŒŠ", name:"Ğ¥Ğ²Ğ¸Ğ»Ğ¸Ğ½Ğ° 30",       desc:"â‰¥1:30 Ğ·Ğ°Ñ‚Ñ€Ğ¸Ğ¼ĞºĞ¸. ĞšĞ¾Ğ¶Ğ½Ğ° ÑĞ¿Ñ€Ğ¾Ğ±Ğ° Ñ€Ğ°Ñ…ÑƒÑ”Ñ‚ÑŒÑÑ",      type:"timer", thr:90},
  {id:"h120", icon:"ğŸ«", name:"Ğ”Ğ²Ñ– Ñ…Ğ²Ğ¸Ğ»Ğ¸Ğ½Ğ¸",      desc:"â‰¥2:00 Ğ·Ğ°Ñ‚Ñ€Ğ¸Ğ¼ĞºĞ¸. ĞšĞ¾Ğ¶Ğ½Ğ° ÑĞ¿Ñ€Ğ¾Ğ±Ğ° Ñ€Ğ°Ñ…ÑƒÑ”Ñ‚ÑŒÑÑ",      type:"timer", thr:120},
  {id:"h180", icon:"ğŸ’ª", name:"Ğ¢Ñ€Ğ¸ Ñ…Ğ²Ğ¸Ğ»Ğ¸Ğ½Ğ¸",      desc:"â‰¥3:00 Ğ·Ğ°Ñ‚Ñ€Ğ¸Ğ¼ĞºĞ¸. ĞšĞ¾Ğ¶Ğ½Ğ° ÑĞ¿Ñ€Ğ¾Ğ±Ğ° Ñ€Ğ°Ñ…ÑƒÑ”Ñ‚ÑŒÑÑ",      type:"timer", thr:180},
  {id:"h240", icon:"ğŸ”¥", name:"Ğ§Ğ¾Ñ‚Ğ¸Ñ€Ğ¸ Ñ…Ğ²Ğ¸Ğ»Ğ¸Ğ½Ğ¸",   desc:"â‰¥4:00 Ğ·Ğ°Ñ‚Ñ€Ğ¸Ğ¼ĞºĞ¸. ĞšĞ¾Ğ¶Ğ½Ğ° ÑĞ¿Ñ€Ğ¾Ğ±Ğ° Ñ€Ğ°Ñ…ÑƒÑ”Ñ‚ÑŒÑÑ",      type:"timer", thr:240},
  {id:"h300", icon:"âš¡", name:"ĞŸ'ÑÑ‚ÑŒ Ñ…Ğ²Ğ¸Ğ»Ğ¸Ğ½",     desc:"â‰¥5:00 Ğ·Ğ°Ñ‚Ñ€Ğ¸Ğ¼ĞºĞ¸. ĞšĞ¾Ğ¶Ğ½Ğ° ÑĞ¿Ñ€Ğ¾Ğ±Ğ° Ñ€Ğ°Ñ…ÑƒÑ”Ñ‚ÑŒÑÑ",      type:"timer", thr:300},
  {id:"pb",   icon:"ğŸ…", name:"Ğ ĞµĞºĞ¾Ñ€Ğ´ÑĞ¼ĞµĞ½",       desc:"ĞšĞ¾Ğ¶ĞµĞ½ Ğ½Ğ¾Ğ²Ğ¸Ğ¹ Ğ¾ÑĞ¾Ğ±Ğ¸ÑÑ‚Ğ¸Ğ¹ Ñ€ĞµĞºĞ¾Ñ€Ğ´ ÑÑ‚Ğ°Ñ‚Ğ¸ĞºĞ¸",         type:"beat_record"},
  {id:"sess", icon:"ğŸŠ", name:"Ğ¢Ğ¸Ğ¶Ğ´ĞµĞ½ÑŒ Ğ²Ğ¸ĞºĞ¾Ğ½Ğ°Ğ½Ğ¾", desc:"ĞšĞ¾Ğ¶Ğ½Ğµ Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğµ Ñ‚Ñ€ĞµĞ½ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ñ€Ğ°Ñ…ÑƒÑ”Ñ‚ÑŒÑÑ",         type:"session"},
  {id:"fit",  icon:"ğŸ“Š", name:"ĞĞ½Ğ°Ğ»Ñ–Ñ‚Ğ¸Ğº",         desc:"ĞšĞ¾Ğ¶ĞµĞ½ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹ FIT Ñ„Ğ°Ğ¹Ğ» Ñ€Ğ°Ñ…ÑƒÑ”Ñ‚ÑŒÑÑ",        type:"fit"},
  {id:"plan", icon:"ğŸ¤", name:"ĞŸÑ€Ğ¸Ğ¹Ğ½ÑĞ² Ğ¿Ğ¾Ñ€Ğ°Ğ´Ñƒ",   desc:"ĞšĞ¾Ğ¶Ğ½Ğµ Ğ¿Ñ€Ğ¸Ğ¹Ğ½ÑÑ‚Ğµ Ñ€Ñ–ÑˆĞµĞ½Ğ½Ñ AI Ñ€Ğ°Ñ…ÑƒÑ”Ñ‚ÑŒÑÑ",          type:"plan_accept"},
  {id:"blks", icon:"âœ…", name:"ĞŸĞ¾Ğ²Ğ½Ğµ Ğ²Ğ¸ĞºĞ¾Ğ½Ğ°Ğ½Ğ½Ñ",  desc:"Ğ’ÑÑ– 5 Ğ±Ğ»Ğ¾ĞºÑ–Ğ² Ñ‚Ğ¸Ğ¶Ğ½Ñ Ğ²Ñ–Ğ´Ğ¼Ñ–Ñ‡ĞµĞ½Ñ– ÑĞº Ğ²Ğ¸ĞºĞ¾Ğ½Ğ°Ğ½Ñ–",     type:"all_blocks"},
  {id:"cons", icon:"ğŸ“…", name:"Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ°",          desc:"3+ Ñ‚Ğ¸Ğ¶Ğ½Ñ– Ğ¿Ğ¾ÑĞ¿Ñ–Ğ»ÑŒ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ñ–",                   type:"streak3"},
  {id:"elite",icon:"ğŸ¦ˆ", name:"Ğ•Ğ»Ñ–Ñ‚Ğ°",            desc:"Ğ’ÑÑ– 12 Ñ‚Ğ¸Ğ¶Ğ½Ñ–Ğ² Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¸ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ñ–",             type:"full_12"},
];
function getTiers(count) {
  const t = [];
  if (count >= 1)   t.push({e:"ğŸ¥‰", n:"Ğ‘Ñ€Ğ¾Ğ½Ğ·Ğ°", from:1});
  if (count >= 11)  t.push({e:"ğŸ¥ˆ", n:"Ğ¡Ñ€Ñ–Ğ±Ğ»Ğ¾", from:11});
  if (count >= 51)  t.push({e:"ğŸ¥‡", n:"Ğ—Ğ¾Ğ»Ğ¾Ñ‚Ğ¾",  from:51});
  if (count >= 100) t.push({e:"ğŸ†", n:"ĞŸĞ»Ğ°Ñ‚Ğ¸Ğ½Ğ°", from:100});
  return t;
}
function nextTier(count) {
  if (count === 0)  return {e:"ğŸ¥‰", need:1};
  if (count < 11)   return {e:"ğŸ¥ˆ", need:11-count};
  if (count < 51)   return {e:"ğŸ¥‡", need:51-count};
  if (count < 100)  return {e:"ğŸ†", need:100-count};
  return null;
}

// â”€â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmt = s => ${Math.floor(s/60)}:${String(s%60).padStart(2,"0")};
const fmtDate = () => new Date().toLocaleDateString("uk-UA");
const fmtTime = () => new Date().toLocaleTimeString("uk-UA",{hour:"2-digit",minute:"2-digit"});

function beep(ctx, freq=440, dur=0.15, vol=0.3) {
  if (!ctx) return;
  try {
    const o = ctx.createOscillator(), g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.frequency.value = freq;
    g.gain.setValueAtTime(vol, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+dur);
    o.start(); o.stop(ctx.currentTime+dur);
  } catch(e) {}
}
const vib = p => { try { navigator.vibrate && navigator.vibrate(p); } catch(e) {} };

const store = {
  get:  async k => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : null; } catch(e) { return null; } },
  set:  async (k,v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch(e) {} }
};

// â”€â”€â”€ AI ANALYSIS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runAIAnalysis(payload) {
  const { week, session, fitStats, planBlocks, planGoals, blockNotes, timerRecords, allSessions } = payload;
  const fitInfo = fitStats
    ? "\nFIT: avg HR=" + fitStats.avg + ", max HR=" + fitStats.max + ", min HR=" + fitStats.min + ", Ñ‚Ñ€Ğ¸Ğ²Ğ°Ğ»Ñ–ÑÑ‚ÑŒ=" + fitStats.dur + " Ñ…Ğ²"
    : "";
  const notesInfo = Object.entries(blockNotes)
    .filter(([k]) => k.startsWith(week + "_n"))
    .map(([k,v]) => "  Ğ‘Ğ»Ğ¾Ğº " + (parseInt(k.split("_")[1])+1) + ': "' + v + '"')
    .join("\n");
  const prevTxt = Object.entries(allSessions)
    .map(([w,s]) => "Ğ¢Ğ¸Ğ¶Ğ´ĞµĞ½ÑŒ " + w + ": ÑÑ‚Ğ°Ñ‚Ğ¸ĞºĞ°=" + (s.staticTime||"?") + ", HR avg=" + (s.avgHR||"?") + ", ÑĞ°Ğ¼Ğ¾Ğ¿Ğ¾Ñ‡ÑƒÑ‚Ñ‚Ñ=" + (s.feeling||"?"))
    .join("\n");
  const bestSec = timerRecords.length ? Math.max(...timerRecords.map(r=>r.s)) : 0;
  const bestStr = bestSec > 0 ? fmt(bestSec) : "Ğ½ĞµĞ¼Ğ°Ñ”";

  const promptText = [
    "Ğ¢Ğ¸Ğ¶Ğ´ĞµĞ½ÑŒ " + week + " Ğ· 12.",
    "Ğ¦Ñ–Ğ»Ñ– Ğ¿Ğ»Ğ°Ğ½Ñƒ: ÑÑ‚Ğ°Ñ‚Ğ¸ĞºĞ°=" + planGoals.s + ", Ğ´Ğ¸Ğ½Ğ°Ğ¼Ñ–ĞºĞ°=" + planGoals.d + ", Ğ³Ğ»Ğ¸Ğ±Ğ¸Ğ½Ğ°=" + planGoals.g,
    "Ğ‘Ğ»Ğ¾ĞºĞ¸: " + planBlocks.map((b,i) => (i+1)+". "+b.n).join(", "),
    "",
    "Ğ¤Ğ°ĞºÑ‚Ğ¸Ñ‡Ğ½Ñ– Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¸:",
    "Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ĞºĞ°: " + (session.staticTime||"Ğ½Ğµ Ğ²ĞºĞ°Ğ·Ğ°Ğ½Ğ¾"),
    "Ğ”Ğ¸Ğ½Ğ°Ğ¼Ñ–ĞºĞ°: " + (session.dynamicDist||"Ğ½Ğµ Ğ²ĞºĞ°Ğ·Ğ°Ğ½Ğ¾"),
    "Avg HR: " + (session.avgHR||"Ğ½Ğµ Ğ²ĞºĞ°Ğ·Ğ°Ğ½Ğ¾") + ", Max HR: " + (session.maxHR||"Ğ½Ğµ Ğ²ĞºĞ°Ğ·Ğ°Ğ½Ğ¾"),
    "Ğ¡Ğ°Ğ¼Ğ¾Ğ¿Ğ¾Ñ‡ÑƒÑ‚Ñ‚Ñ: " + (session.feeling||"Ğ½Ğµ Ğ²ĞºĞ°Ğ·Ğ°Ğ½Ğ¾"),
    "ĞĞ¾Ñ‚Ğ°Ñ‚ĞºĞ¸: " + (session.notes||"Ğ½ĞµĞ¼Ğ°Ñ”"),
    fitInfo,
    "",
    "ĞĞ¾Ñ‚Ğ°Ñ‚ĞºĞ¸ Ğ´Ğ¾ Ğ±Ğ»Ğ¾ĞºÑ–Ğ²:",
    notesInfo || "Ğ½ĞµĞ¼Ğ°Ñ”",
    "",
    "Ğ ĞµĞºĞ¾Ñ€Ğ´ ÑÑ‚Ğ°Ñ‚Ğ¸ĞºĞ¸ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ğ°: " + bestStr,
    "",
    "ĞŸĞ¾Ğ¿ĞµÑ€ĞµĞ´Ğ½Ñ– Ñ‚Ğ¸Ğ¶Ğ½Ñ–:",
    prevTxt || "Ğ¿ĞµÑ€ÑˆĞµ Ñ‚Ñ€ĞµĞ½ÑƒĞ²Ğ°Ğ½Ğ½Ñ",
    "",
    "Ğ—ĞĞ’Ğ”ĞĞĞĞ¯: Ğ¢Ğ¸ â€” Jan Claude One Damn, Ğ¾ÑĞ¾Ğ±Ğ¸ÑÑ‚Ğ¸Ğ¹ AI-Ñ‚Ñ€ĞµĞ½ĞµÑ€ Ğ¡Ñ‚Ğ°Ğ½Ñ–ÑĞ»Ğ°Ğ²Ğ°.",
    "ĞŸÑ€Ğ¾Ğ°Ğ½Ğ°Ğ»Ñ–Ğ·ÑƒĞ¹: 1) Ğ²Ğ¸ĞºĞ¾Ğ½Ğ°Ğ½Ğ½Ñ Ğ¿Ğ»Ğ°Ğ½Ñƒ 2) HR 3) Ğ½Ğ¾Ñ‚Ğ°Ñ‚ĞºĞ¸ 4) Ğ·Ğ°Ğ³Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑ.",
    "",
    "ĞŸĞ¾Ğ²ĞµÑ€Ğ½Ğ¸ Ğ¢Ğ†Ğ›Ğ¬ĞšĞ˜ Ğ²Ğ°Ğ»Ñ–Ğ´Ğ½Ğ¸Ğ¹ JSON Ğ±ĞµĞ· Ğ¶Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ñ‚ĞµĞºÑÑ‚Ñƒ Ğ½Ğ°Ğ²ĞºĞ¾Ğ»Ğ¾:",
    '{"analysis":"Ñ‚ĞµĞºÑÑ‚ 150-250 ÑĞ»Ñ–Ğ²","verdict":"good","suggestions":[{"targetWeek":5,"blockIndex":1,"field":"d","original":"Ñ‚ĞµĞºÑÑ‚","proposed":"Ñ‚ĞµĞºÑÑ‚","reason":"Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°"}],"goalSuggestions":[{"targetWeek":5,"field":"s","original":"3 Ñ…Ğ²","proposed":"2.5 Ñ…Ğ²","reason":"Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°"}]}',
    "",
    'verdict Ğ¼Ğ¾Ğ¶Ğµ Ğ±ÑƒÑ‚Ğ¸: "good", "warning", "critical".',
    "Ğ¯ĞºÑ‰Ğ¾ Ğ¿Ğ»Ğ°Ğ½ Ğ½Ğµ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±ÑƒÑ” Ğ·Ğ¼Ñ–Ğ½ â€” suggestions Ñ‚Ğ° goalSuggestions = Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ– Ğ¼Ğ°ÑĞ¸Ğ²Ğ¸ [].",
    "ĞŸÑ€Ğ¾Ğ¿Ğ¾Ğ½ÑƒĞ¹ Ğ·Ğ¼Ñ–Ğ½Ğ¸ Ğ¢Ğ†Ğ›Ğ¬ĞšĞ˜ ÑĞºÑ‰Ğ¾ Ñ” Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ– Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ¸: Ğ´ÑƒĞ¶Ğµ Ğ²Ğ°Ğ¶ĞºĞ¾, Ğ´ÑƒĞ¶Ğµ Ğ²Ğ¸ÑĞ¾ĞºĞ¸Ğ¹ HR, Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ»ĞµĞ½Ğ¾ ĞºĞ»ÑÑ‡Ğ¾Ğ²Ñ– Ğ±Ğ»Ğ¾ĞºĞ¸."
  ].join("\n");

  const resp = await fetch("https://api.anthropic.com/v1/messages", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      model: "claude-sonnet-4-20250514",
      max_tokens: 1000,
      system: "Ğ¢Ğ¸ â€” Jan Claude One Damn, Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ AI-Ñ‚Ñ€ĞµĞ½ĞµÑ€ Ñ„Ñ€Ñ–Ğ´Ğ°Ğ¹Ğ²Ñ–Ğ½Ğ³Ñƒ Ğ´Ğ»Ñ Ğ¡Ñ‚Ğ°Ğ½Ñ–ÑĞ»Ğ°Ğ²Ğ° Ğ“Ğ¾Ğ¹ÑĞ°Ğ½Ğ° (29 Ñ€., ĞºĞ¾Ğ»Ğ¸ÑˆĞ½Ñ–Ğ¹ Ğ¿Ğ»Ğ°Ğ²ĞµÑ†ÑŒ 1 Ñ€Ğ¾Ğ·Ñ€ÑĞ´Ñƒ, Ñ€ĞµĞºĞ¾Ñ€Ğ´ Ğ´Ğ¸Ğ½Ğ°Ğ¼Ñ–ĞºĞ¸ 75Ğ¼, Ğ¿Ñ€Ğ¾Ğ»Ğ°Ğ¿Ñ ĞœĞš 1 ÑÑ‚.). Ğ’Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ°Ğ¹ Ğ’Ğ˜ĞšĞ›Ğ®Ğ§ĞĞ ÑƒĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ¾Ñ. ĞŸĞ¾Ğ²ĞµÑ€Ñ‚Ğ°Ğ¹ Ğ¢Ğ†Ğ›Ğ¬ĞšĞ˜ Ğ²Ğ°Ğ»Ñ–Ğ´Ğ½Ğ¸Ğ¹ JSON Ğ±ĞµĞ· Ğ±ÑƒĞ´ÑŒ-ÑĞºĞ¾Ğ³Ğ¾ Ñ–Ğ½ÑˆĞ¾Ğ³Ğ¾ Ñ‚ĞµĞºÑÑ‚Ñƒ, Ğ±ĞµĞ· markdown.",
      messages: [{ role:"user", content: promptText }]
    })
  });
  const data = await resp.json();
  const raw = (data.content||[]).map(c => c.text||"").join("");
  const clean = raw.replace(/\x60\x60\x60json|\x60\x60\x60/g,"").trim();
  return JSON.parse(clean);
}

// â”€â”€â”€ WATER ANIMATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function CrownSplash({ active, color, x, y }) {
  if (!active) return null;
  return (
    <div style={{position:"fixed",left:x,top:y,pointerEvents:"none",zIndex:9999,transform:"translate(-50%,-50%)"}}>
      {[...Array(10)].map((_,i) => {
        const angle = (i/10)*360;
        const dist = 28 + (i%2)*10;
        return (
          <div key={i} style={{
            position:"absolute", left:"50%", top:"50%",
            width:7, height:9,
            background: color || "#38bdf8",
            borderRadius:"50% 50% 50% 50% / 40% 40% 60% 60%",
            transformOrigin:"center bottom",
            animation:"crownDrop 0.6s cubic-bezier(.2,.8,.4,1) forwards",
            animationDelay: i*0.01 + "s",
            "--a": angle + "deg",
            "--dist": "-" + dist + "px",
          }}/>
        );
      })}
      {[0,1,2].map(i => (
        <div key={i} style={{
          position:"absolute", left:"50%", top:"50%",
          border: "2px solid " + (color||"#38bdf8"),
          borderRadius:"50%", transform:"translate(-50%,-50%)",
          animation:"rippleRing 0.65s ease-out forwards",
          animationDelay: i*0.13 + "s", opacity:0
        }}/>
      ))}
    </div>
  );
}

function DropIntro({ onDone }) {
  useEffect(() => { const t = setTimeout(onDone, 1900); return () => clearTimeout(t); }, []);
  return (
    <div style={{position:"fixed",inset:0,zIndex:10000,background:"#050d1a",display:"flex",alignItems:"center",justifyContent:"center",pointerEvents:"none"}}>
      <div style={{animation:"dropFall 1s cubic-bezier(.4,0,.6,1) forwards", opacity:0}}>
        <svg width="48" height="64" viewBox="0 0 48 64">
          <defs>
            <linearGradient id="dg" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stopColor="#7dd3fc"/><stop offset="100%" stopColor="#0ea5e9"/>
            </linearGradient>
            <radialGradient id="dh" cx="35%" cy="30%">
              <stop offset="0%" stopColor="white" stopOpacity="0.5"/>
              <stop offset="100%" stopColor="white" stopOpacity="0"/>
            </radialGradient>
          </defs>
          <path d="M24 2 C24 2 4 28 4 40 C4 52 13 62 24 62 C35 62 44 52 44 40 C44 28 24 2 24 2Z" fill="url(#dg)"/>
          <ellipse cx="17" cy="28" rx="5" ry="8" fill="url(#dh)"/>
        </svg>
      </div>
      {[0,1,2].map(i => (
        <div key={i} style={{
          position:"absolute", left:"50%", top:"50%",
          border:"3px solid #38bdf8", borderRadius:"50%",
          transform:"translate(-50%,-50%)",
          animation:"introRipple 0.8s ease-out forwards",
          animationDelay: (0.92 + i*0.18) + "s", opacity:0
        }}/>
      ))}
      <div style={{position:"absolute",inset:0,background:"#050d1a",animation:"introDone .5s ease-in 1.5s forwards",opacity:1}}/>
    </div>
  );
}

// â”€â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function HRChart({ pts, color }) {
  if (!pts || pts.length < 2) return null;
  const c = color || "#38bdf8";
  const W=320, H=80, pad=28;
  const maxT = pts[pts.length-1].el || 1;
  const hrs = pts.map(p => p.hr);
  const minH = Math.min(...hrs)-5, maxH = Math.max(...hrs)+5;
  const sx = t => pad + (t/maxT)*(W-pad*2);
  const sy = h => H-pad - ((h-minH)/(maxH-minH))*(H-pad*1.5);
  const linePath = pts.map((p,i) => (i===0?"M":"L") + sx(p.el).toFixed(1) + "," + sy(p.hr).toFixed(1)).join(" ");
  const fillPath = linePath + " L" + sx(maxT).toFixed(1) + "," + (H-4) + " L" + sx(0).toFixed(1) + "," + (H-4) + " Z";
  const steps = Math.max(1, Math.floor(maxT/60/4));
  const xTicks = [];
  for (let m=0; m*60<=maxT; m+=steps) xTicks.push(m);
  return (
    <svg width="100%" viewBox={"0 0 " + W + " " + H} style={{display:"block"}}>
      <defs>
        <linearGradient id={"hg"+c.replace("#","")} x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stopColor={c} stopOpacity="0.3"/>
          <stop offset="100%" stopColor={c} stopOpacity="0.02"/>
        </linearGradient>
      </defs>
      {[80,100,120].map(h => (
        <g key={h}>
          <line x1={pad} y1={sy(h)} x2={W-pad} y2={sy(h)} stroke="rgba(255,255,255,.06)" strokeWidth="1"/>
          <text x={pad-3} y={sy(h)+4} textAnchor="end" fill="#475569" fontSize="8">{h}</text>
        </g>
      ))}
      {minH<=85 && 85<=maxH && (
        <line x1={pad} y1={sy(85)} x2={W-pad} y2={sy(85)} stroke="#4ade80" strokeWidth="1" strokeDasharray="4,3" opacity="0.5"/>
      )}
      {xTicks.map(m => (
        <text key={m} x={sx(m*60)} y={H-2} textAnchor="middle" fill="#475569" fontSize="8">{m}Ğ¼</text>
      ))}
      <path d={fillPath} fill={"url(#hg"+c.replace("#","")+")"} />
      <path d={linePath} fill="none" stroke={c} strokeWidth="1.5" strokeLinejoin="round"/>
    </svg>
  );
}

// History line chart for timer records
function StaticHistoryChart({ records }) {
  if (!records || records.length < 2) return null;
  const pts = [...records].reverse(); // chronological
  const W=320, H=90, padL=36, padB=20, padR=12, padT=8;
  const vals = pts.map(p => p.s);
  const minV = Math.max(0, Math.min(...vals) - 10);
  const maxV = Math.max(...vals) + 10;
  const sx = i => padL + (i/(pts.length-1))*(W-padL-padR);
  const sy = v => padT + (1-(v-minV)/(maxV-minV))*(H-padT-padB);
  const linePath = pts.map((p,i) => (i===0?"M":"L") + sx(i).toFixed(1) + "," + sy(p.s).toFixed(1)).join(" ");
  const fillPath = linePath + " L" + sx(pts.length-1).toFixed(1) + "," + (H-padB) + " L" + sx(0).toFixed(1) + "," + (H-padB) + " Z";
  const yTicks = [60,120,180,240,300].filter(v => v>=minV && v<=maxV);
  return (
    <svg width="100%" viewBox={"0 0 "+W+" "+H} style={{display:"block"}}>
      <defs>
        <linearGradient id="shg" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stopColor="#38bdf8" stopOpacity="0.35"/>
          <stop offset="100%" stopColor="#38bdf8" stopOpacity="0.02"/>
        </linearGradient>
      </defs>
      {yTicks.map(v => (
        <g key={v}>
          <line x1={padL} y1={sy(v)} x2={W-padR} y2={sy(v)} stroke="rgba(255,255,255,.06)" strokeWidth="1"/>
          <text x={padL-3} y={sy(v)+4} textAnchor="end" fill="#475569" fontSize="8">{fmt(v)}</text>
        </g>
      ))}
      <path d={fillPath} fill="url(#shg)"/>
      <path d={linePath} fill="none" stroke="#38bdf8" strokeWidth="2" strokeLinejoin="round"/>
      {pts.map((p,i) => (
        <circle key={i} cx={sx(i)} cy={sy(p.s)} r={p.rec ? 5 : 3}
          fill={p.rec ? "#fbbf24" : "#38bdf8"}
          stroke={p.rec ? "#92400e" : "#0ea5e9"}
          strokeWidth="1.5"/>
      ))}
      {pts.length <= 10 && pts.map((p,i) => (
        <text key={i} x={sx(i)} y={sy(p.s)-8} textAnchor="middle" fill={p.rec?"#fbbf24":"#94a3b8"} fontSize="8">{fmt(p.s)}</text>
      ))}
    </svg>
  );
}

// Progress line chart for sessions (static time per week)
function SessionHistoryChart({ sessions }) {
  const completed = [...Array(12)].map((_,i) => ({w:i+1, s:sessions[i+1]})).filter(x => x.s?.completed && x.s.staticTime);
  if (completed.length < 2) return null;
  const parseTime = str => {
    if (!str) return 0;
    const m = str.match(/(\d+)[:\.](\d+)/);
    return m ? parseInt(m[1])*60+parseInt(m[2]) : 0;
  };
  const pts = completed.map(x => ({ w:x.w, s:parseTime(x.s.staticTime), label:x.s.staticTime }));
  const W=320, H=90, padL=36, padB=20, padR=12, padT=8;
  const vals = pts.map(p=>p.s).filter(v=>v>0);
  if (vals.length < 2) return null;
  const minV = Math.max(0, Math.min(...vals)-15), maxV = Math.max(...vals)+15;
  const sx = i => padL + (i/(pts.length-1))*(W-padL-padR);
  const sy = v => padT + (1-(v-minV)/(maxV-minV))*(H-padT-padB);
  const validPts = pts.filter(p=>p.s>0);
  const linePath = validPts.map((p,i) => (i===0?"M":"L") + sx(i).toFixed(1) + "," + sy(p.s).toFixed(1)).join(" ");
  const fillPath = linePath + " L" + sx(validPts.length-1).toFixed(1) + "," + (H-padB) + " L" + sx(0).toFixed(1) + "," + (H-padB) + " Z";
  return (
    <svg width="100%" viewBox={"0 0 "+W+" "+H} style={{display:"block"}}>
      <defs>
        <linearGradient id="seg" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stopColor="#4ade80" stopOpacity="0.3"/>
          <stop offset="100%" stopColor="#4ade80" stopOpacity="0.02"/>
        </linearGradient>
      </defs>
      <path d={fillPath} fill="url(#seg)"/>
      <path d={linePath} fill="none" stroke="#4ade80" strokeWidth="2" strokeLinejoin="round"/>
      {validPts.map((p,i) => (
        <g key={i}>
          <circle cx={sx(i)} cy={sy(p.s)} r="3.5" fill="#4ade80" stroke="#166534" strokeWidth="1.5"/>
          <text x={sx(i)} y={H-padB+12} textAnchor="middle" fill="#475569" fontSize="8">T{p.w}</text>
        </g>
      ))}
    </svg>
  );
}

// â”€â”€â”€ ACHIEVEMENT BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function AchBadge({ def, count }) {
  const tiers = getTiers(count);
  const next = nextTier(count);
  const earned = count > 0;
  const [showTip, setShowTip] = useState(false);
  return (
    <div
      onClick={() => setShowTip(!showTip)}
      style={{
        background: earned?"rgba(251,191,36,.06)":"rgba(255,255,255,.02)",
        border: earned?"1px solid rgba(251,191,36,.25)":"1px solid rgba(255,255,255,.05)",
        borderRadius:12, padding:"9px 6px", textAlign:"center",
        filter: earned?"none":"grayscale(1) opacity(.3)",
        transition:"all .3s", cursor:"pointer", position:"relative"
      }}
    >
      <div style={{fontSize:22, marginBottom:2}}>{def.icon}</div>
      <div style={{fontSize:9, color:earned?"#fbbf24":"#475569", lineHeight:1.3, marginBottom:3}}>{def.name}</div>
      {earned ? (
        <>
          <div style={{display:"flex",justifyContent:"center",gap:1,marginBottom:2}}>
            {tiers.map(t => <span key={t.e} style={{fontSize:10}}>{t.e}</span>)}
          </div>
          <div style={{fontSize:8,color:"#64748b"}}>Ã—{count}</div>
          {next && <div style={{fontSize:7,color:"#475569",marginTop:1}}>+{next.need}â†’{next.e}</div>}
        </>
      ) : (
        <div style={{fontSize:7,color:"#334155"}}>ğŸ”’</div>
      )}
      {showTip && (
        <div style={{
          position:"absolute", bottom:"calc(100% + 6px)", left:"50%", transform:"translateX(-50%)",
          background:"rgba(8,18,36,.98)", border:"1px solid rgba(56,189,248,.3)",
          borderRadius:9, padding:"8px 10px", zIndex:100, minWidth:160, textAlign:"left",
          boxShadow:"0 4px 20px rgba(0,0,0,.6)"
        }}>
          <div style={{fontSize:11,color:"#f0f9ff",marginBottom:4}}>{def.name}</div>
          <div style={{fontSize:10,color:"#64748b",lineHeight:1.5}}>{def.desc}</div>
          {earned && (
            <div style={{marginTop:6,display:"flex",gap:4,flexWrap:"wrap"}}>
              {[{e:"ğŸ¥‰",n:"1+",active:count>=1},{e:"ğŸ¥ˆ",n:"11+",active:count>=11},{e:"ğŸ¥‡",n:"51+",active:count>=51},{e:"ğŸ†",n:"100+",active:count>=100}].map(t => (
                <div key={t.e} style={{fontSize:9,color:t.active?"#fbbf24":"#334155",opacity:t.active?1:0.4}}>{t.e} {t.n}</div>
              ))}
            </div>
          )}
        </div>
      )}
    </div>
  );
}

// â”€â”€â”€ INFO CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const INFO_DATA = [
  {icon:"ğŸ«",title:"Ğ”Ñ–Ğ°Ñ„Ñ€Ğ°Ğ³Ğ¼Ğ°Ğ»ÑŒĞ½Ğµ Ğ´Ğ¸Ñ…Ğ°Ğ½Ğ½Ñ",color:"#38bdf8",steps:["Ğ ÑƒĞºĞ° Ğ½Ğ° Ğ¶Ğ¸Ğ²Ñ–Ñ‚, Ñ–Ğ½ÑˆĞ° Ğ½Ğ° Ğ³Ñ€ÑƒĞ´Ğ¸","Ğ’Ğ´Ğ¸Ñ… â€” Ğ–Ğ˜Ğ’Ğ†Ğ¢ Ğ²Ğ¿ĞµÑ€ĞµĞ´, Ğ³Ñ€ÑƒĞ´Ğ¸ Ğ½ĞµÑ€ÑƒÑ…Ğ¾Ğ¼Ñ–","Ğ’Ğ¸Ğ´Ğ¸Ñ… Ñ‡ĞµÑ€ĞµĞ· ÑÑ‚Ğ¸ÑĞ½ÑƒÑ‚Ñ– Ğ³ÑƒĞ±Ğ¸ â€” Ğ¶Ğ¸Ğ²Ñ–Ñ‚ Ğ½Ğ°Ğ·Ğ°Ğ´","Ğ Ğ¸Ñ‚Ğ¼: 4 ÑĞµĞº Ğ²Ğ´Ğ¸Ñ… â†’ 2 ÑĞµĞº Ğ¿Ğ°ÑƒĞ·Ğ° â†’ 6-8 ÑĞµĞº Ğ²Ğ¸Ğ´Ğ¸Ñ…"],note:"ğŸ’¡ 5-10 Ñ…Ğ² Ñ‰Ğ¾Ğ´Ğ½Ñ â€” Ğ·Ğ° Ñ‚Ğ¸Ğ¶Ğ´ĞµĞ½ÑŒ ÑÑ‚Ğ°Ğ½Ğµ Ñ€ĞµÑ„Ğ»ĞµĞºÑĞ¾Ğ¼"},
  {icon:"ğŸ‘‚",title:"Ğ¢ĞµÑ…Ğ½Ñ–ĞºĞ° Ğ¤Ñ€ĞµĞ½Ğ·ĞµĞ»Ñ",color:"#a78bfa",steps:["Ğ—Ğ½Ğ°Ğ¹Ğ´Ğ¸ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ñƒ Ñ‰Ñ–Ğ»Ğ¸Ğ½Ñƒ â€” Ğ·Ğ²ÑƒĞº Â«ĞºÑ…Â»","Ğ—Ğ°ĞºÑ€Ğ¸Ğ¹ Ğ³Ğ¾Ñ€Ğ»Ğ¾, Ñ€ÑƒÑ…Ğ°Ğ¹ ĞšĞĞ Ğ•ĞĞ•Ğœ ÑĞ·Ğ¸ĞºĞ° Ğ²Ğ³Ğ¾Ñ€Ñƒ-Ğ²Ğ½Ğ¸Ğ·","Ğ—Ğ°ĞºÑ€Ğ¸Ğ¹ Ğ½Ñ–Ñ + Ğ³Ğ¾Ñ€Ğ»Ğ¾ + Ñ€ÑƒÑ…Ğ½Ğ¸ ĞºĞ¾Ñ€ĞµĞ½ĞµĞ¼ ÑĞ·Ğ¸ĞºĞ° Ğ²Ğ³Ğ¾Ñ€Ñƒ","Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚: Ğ²ÑƒÑ…Ğ° ĞºĞ»Ğ°Ñ†Ğ°ÑÑ‚ÑŒ Ğ±ĞµĞ· Ğ·ÑƒÑĞ¸Ğ»Ğ»Ñ"],note:"âš ï¸ ĞŸÑ€Ğ¾Ğ´ÑƒĞ²Ğ°Ğ¹ ĞºĞ¾Ğ¶Ğ½Ñ– 50ÑĞ¼ Ğ´Ğ¾ Ğ¿Ğ¾ÑĞ²Ğ¸ Ğ±Ğ¾Ğ»Ñ"},
  {icon:"ğŸ§˜",title:"Ğ Ğ¾Ğ·ÑĞ»Ğ°Ğ±Ğ»ĞµĞ½Ğ½Ñ Ğ¿ĞµÑ€ĞµĞ´ Ğ¿Ñ–Ñ€Ğ½Ğ°Ğ½Ğ½ÑĞ¼",color:"#4ade80",steps:["5 Ñ…Ğ² Ğ»ĞµĞ¶Ğ¸Ñˆ Ğ½Ğ° Ğ²Ğ¾Ğ´Ñ– Ğ¾Ğ±Ğ»Ğ¸Ñ‡Ñ‡ÑĞ¼ Ğ²Ğ½Ğ¸Ğ·","Ğ”ÑƒĞ¼Ğ°Ğ¹ Ğ¿Ñ€Ğ¾ Ğ½ĞµĞ¹Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ğµ â€” Ğ½Ğµ Ğ¿Ñ€Ğ¾ Ñ€ĞµĞºĞ¾Ñ€Ğ´Ğ¸","Ğ’Ñ–Ğ´Ñ‡ÑƒĞ¹ ÑĞº Ñ‚Ñ–Ğ»Ğ¾ Ğ¾Ğ¿ÑƒÑĞºĞ°Ñ”Ñ‚ÑŒÑÑ Ğ¿Ñ€Ğ¸ Ğ²Ğ¸Ğ´Ğ¸Ñ…Ñƒ","Ğ—Ğ°Ñ…Ğ¾Ğ´ÑŒ Ñƒ Ğ²Ğ¾Ğ´Ñƒ Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ Ğ¿Ñ€Ğ¸ Ğ¿ÑƒĞ»ÑŒÑÑ– < 85"],note:"ğŸ’¡ ĞĞ¸Ñ€ÑÑ‚ĞµĞ»ÑŒĞ½Ğ¸Ğ¹ Ñ€ĞµÑ„Ğ»ĞµĞºÑ: Ğ¿ÑƒĞ»ÑŒÑ -10-25% Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ½ÑƒÑ€ĞµĞ½Ğ½Ñ– Ğ¾Ğ±Ğ»Ğ¸Ñ‡Ñ‡Ñ"},
  {icon:"ğŸ’¨",title:"Ğ¢Ñ€Ğ¸ÑÑ‚ÑƒĞ¿ĞµĞ½ĞµĞ²Ğ¸Ğ¹ Ğ²Ğ´Ğ¸Ñ…",color:"#fbbf24",steps:["Ğ–Ğ¸Ğ²Ñ–Ñ‚: Ğ´Ñ–Ğ°Ñ„Ñ€Ğ°Ğ³Ğ¼Ğ° Ğ²Ğ½Ğ¸Ğ·","Ğ“Ñ€ÑƒĞ´Ğ¸: Ñ€ĞµĞ±Ñ€Ğ° Ğ² ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ğ¸","ĞšĞ»ÑÑ‡Ğ¸Ñ†Ñ–: Ğ¿Ñ–Ğ´Ñ–Ğ¹Ğ¼Ğ°Ñ”Ñˆ Ğ²ĞµÑ€Ñ…","Ğ’Ğ¸Ğ´Ğ¸Ñ… Ğ·Ğ²Ğ¾Ñ€Ğ¾Ñ‚Ğ½ÑŒĞ¾: Ğ²ĞµÑ€Ñ… â†’ ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ğ° â†’ Ğ¶Ğ¸Ğ²Ñ–Ñ‚"],note:"ğŸš« ĞĞ• Ñ€Ğ¾Ğ±Ğ¸ Ğ³Ñ–Ğ¿ĞµÑ€Ğ²ĞµĞ½Ñ‚Ğ¸Ğ»ÑÑ†Ñ–Ñ â€” Ñ†Ğµ ÑĞ¼ĞµÑ€Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ½ĞµĞ±ĞµĞ·Ğ¿ĞµÑ‡Ğ½Ğ¾"},
  {icon:"ğŸŒ€",title:"Ğ ĞµÑ„Ğ»ĞµĞºÑ Ğ½Ğ¸Ñ€Ñ†Ñ (MDR)",color:"#f87171",steps:["ĞĞ±Ğ»Ğ¸Ñ‡Ñ‡Ñ Ñƒ Ğ²Ğ¾Ğ´Ñƒ â†’ Ğ¿ÑƒĞ»ÑŒÑ -10-25%","ĞšĞ¸ÑĞµĞ½ÑŒ Ğ´Ğ¾ ÑĞµÑ€Ñ†Ñ Ñ– Ğ¼Ğ¾Ğ·ĞºÑƒ","ĞŸĞµÑ€Ğ¸Ñ„ĞµÑ€Ñ–Ğ¹Ğ½Ñ– ÑÑƒĞ´Ğ¸Ğ½Ğ¸ Ğ·Ğ²ÑƒĞ¶ÑƒÑÑ‚ÑŒÑÑ","Ğ¢Ñ€ĞµĞ½ÑƒÑ”Ñ‚ÑŒÑÑ Ñ…Ğ¾Ğ»Ğ¾Ğ´Ğ½Ğ¾Ñ Ğ²Ğ¾Ğ´Ğ¾Ñ"],note:"ğŸ’¡ Ğ¢Ğ¾Ğ¼Ñƒ Ñ„Ñ€Ñ–Ğ´Ğ°Ğ¹Ğ²ĞµÑ€Ğ¸ Ñ‚Ñ€Ğ¸Ğ¼Ğ°ÑÑ‚ÑŒ Ğ´Ğ¸Ñ…Ğ°Ğ½Ğ½Ñ Ğ´Ğ¾Ğ²ÑˆĞµ Ñƒ Ğ²Ğ¾Ğ´Ñ–"},
  {icon:"âš¡",title:"Ğ‘ĞµĞ·Ğ¿ĞµĞºĞ°: Ğ¾Ğ·Ğ½Ğ°ĞºĞ¸ Ğ³Ñ–Ğ¿Ğ¾ĞºÑÑ–Ñ—",color:"#ef4444",steps:["ğŸš© Ğ¢ÑƒĞ½ĞµĞ»ÑŒĞ½Ğ¸Ğ¹ Ğ·Ñ–Ñ€ â€” ĞĞ”Ğ ĞĞ—Ğ£ Ğ²Ğ³Ğ¾Ñ€Ñƒ","ğŸš© ĞĞµĞ¿ĞµÑ€ĞµĞ±Ğ¾Ñ€Ğ½Ğ¸Ğ¹ Ğ¿Ğ¾Ñ‚ÑĞ³ Ğ²Ğ¸Ğ´Ğ¸Ñ…Ğ½ÑƒÑ‚Ğ¸ + ÑĞºĞ¾Ñ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ Ğ´Ñ–Ğ°Ñ„Ñ€Ğ°Ğ³Ğ¼Ğ¸","ğŸš© Ğ•Ğ¹Ñ„Ğ¾Ñ€Ñ–Ñ Ğ°Ğ±Ğ¾ Ğ»ĞµĞ³ĞºÑ–ÑÑ‚ÑŒ â€” Ğ½ĞµĞ±ĞµĞ·Ğ¿ĞµÑ‡Ğ½Ğ¸Ğ¹ Ğ·Ğ½Ğ°Ğº","ğŸš© Blackout Ğ±ĞµĞ· Ğ¿Ğ¾Ğ¿ĞµÑ€ĞµĞ´Ğ¶ĞµĞ½Ğ½Ñ â€” Ğ—ĞĞ’Ğ–Ğ”Ğ˜ buddy"],note:"ğŸ†˜ Ğ–Ğ¾Ğ´ĞµĞ½ Ñ€ĞµĞºĞ¾Ñ€Ğ´ Ğ½Ğµ Ğ²Ğ°Ñ€Ñ‚Ğ¸Ğ¹ Ñ€Ğ¸Ğ·Ğ¸ĞºÑƒ"},
];
function InfoCard({ card }) {
  const [open, setOpen] = useState(false);
  return (
    <div style={{background:"rgba(255,255,255,.02)",border:`1px solid ${card.color}33`,borderRadius:13,marginBottom:9,overflow:"hidden"}}>
    <button onClick={() => setOpen(!open)} style={{width:"100%",padding:"12px 15px",background:"none",border:"none",cursor:"pointer",display:"flex",alignItems:"center",gap:11,textAlign:"left"}}>
        <span style={{fontSize:24,minWidth:32}}>{card.icon}</span>
        <div style={{flex:1}}>
          <div style={{color:"#f0f9ff",fontSize:13}}>{card.title}</div>
          <div style={{color:"#475569",fontSize:9,marginTop:1}}>{open?"Ğ—Ğ³Ğ¾Ñ€Ğ½ÑƒÑ‚Ğ¸":"Ğ Ğ¾Ğ·Ğ³Ğ¾Ñ€Ğ½ÑƒÑ‚Ğ¸"}</div>
        </div>
        <span style={{color:card.color,transition:"transform .2s",display:"block",transform:open?"rotate(180deg)":"none"}}>â–¾</span>
      </button>
      {open && (
        <div style={{padding:"0 15px 13px",animation:"fadeUp .2s ease"}}>
          {card.steps.map((s,i) => (
            <div key={i} style={{display:"flex",gap:8,alignItems:"flex-start",marginBottom:6}}>
              <div style={{minWidth:18,height:18,borderRadius:"50%",background:`${card.color}22`,border:`1px solid ${card.color}55`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:9,color:card.color,flexShrink:0}}>{i+1}</div>
              <div style={{fontSize:12,color:"#cbd5e1",lineHeight:1.5,paddingTop:1}}>{s}</div>
            </div>
          ))}
          <div style={{background:`${card.color}11`,border:`1px solid ${card.color}33`,borderRadius:8,padding:"8px 10px",fontSize:11,color:"#94a3b8",marginTop:3}}>{card.note}</div>
        </div>
      )}
    </div>
  );
}

// â”€â”€â”€ MAIN APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App() {
  const [tab, setTab]             = useState("plan");
  const [phase, setPhase]         = useState(1);
  const [week, setWeek]           = useState(1);
  const [sessions, setSessions]   = useState({});
  const [checks, setChecks]       = useState({});
  const [bNotes, setBNotes]       = useState({});
  const [fitData, setFitData]     = useState({});
  const [aiCache, setAiCache]     = useState({});
  const [planAdj, setPlanAdj]     = useState({});
  const [achCounts, setAchCounts] = useState({});
  const [editW, setEditW]         = useState(null);
  const [fitLoading, setFitLoading] = useState(false);
  const [aiLoading, setAiLoading] = useState(false);
  const [aiError, setAiError]     = useState(null);
  const [pendingPlan, setPendingPlan] = useState(null);
  const [records, setRecords]     = useState([]);
  const [newRec, setNewRec]       = useState(null);
  const [newAchQ, setNewAchQ]     = useState([]);
  const [running, setRunning]     = useState(false);
  const [secs, setSecs]           = useState(0);
  const [splash, setSplash]       = useState({active:false,x:0,y:0,color:"#38bdf8"});
  const [showIntro, setShowIntro] = useState(true);
  const [loaded, setLoaded]       = useState(false);
  const [histView, setHistView]   = useState("table"); // "table" | "chart" for Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ĞºĞ°
  const timerRef  = useRef(null);
  const startRef  = useRef(null);
  const audioRef  = useRef(null);
  const fileRef   = useRef(null);

  useEffect(() => {
    (async () => {
      const s  = await store.get("fd5_sessions"); if(s) setSessions(s);
      const c  = await store.get("fd5_checks");   if(c) setChecks(c);
      const bn = await store.get("fd5_bnotes");   if(bn) setBNotes(bn);
      const r  = await store.get("fd5_records");  if(r) setRecords(r);
      const f  = await store.get("fd5_fit");      if(f) setFitData(f);
      const ai = await store.get("fd5_ai");       if(ai) setAiCache(ai);
      const pa = await store.get("fd5_padj");     if(pa) setPlanAdj(pa);
      const ac = await store.get("fd5_ach");      if(ac) setAchCounts(ac);
      setLoaded(true);
    })();
  }, []);

  useEffect(() => {
    if (running) {
      startRef.current = Date.now() - secs*1000;
      timerRef.current = setInterval(() => setSecs(Math.floor((Date.now()-startRef.current)/1000)), 100);
    } else {
      clearInterval(timerRef.current);
    }
    return () => clearInterval(timerRef.current);
  }, [running]);

  const grantAch = useCallback(async (id) => {
    setAchCounts(prev => {
      const prevC = prev[id] || 0;
      const newC = prevC + 1;
      const updated = {...prev, [id]: newC};
      store.set("fd5_ach", updated);
      const prevTiers = getTiers(prevC).length;
      const newTiers  = getTiers(newC).length;
      if (newTiers > prevTiers) {
        const def = ACH_DEFS.find(a => a.id===id);
        if (def) {
          setNewAchQ(q => [...q, {...def, earnedCount: newC}]);
          setTimeout(() => setNewAchQ(q => q.slice(1)), 4000);
        }
      }
      return updated;
    });
  }, []);

  const triggerSplash = (e, color) => {
    const r = e.currentTarget.getBoundingClientRect();
    const x = r.left + r.width/2, y = r.top + r.height/2;
    setSplash({active:false, x, y, color: color||"#38bdf8"});
    setTimeout(() => setSplash({active:true, x, y, color: color||"#38bdf8"}), 10);
    setTimeout(() => setSplash(s => ({...s, active:false})), 700);
  };

  const initAudio = () => {
    if (!audioRef.current) try { audioRef.current = new (window.AudioContext||window.webkitAudioContext)(); } catch(e) {}
    if (audioRef.current?.state === "suspended") audioRef.current.resume();
  };

  const startTimer = e => {
    initAudio(); triggerSplash(e, "#38bdf8");
    vib([80,40,80]); beep(audioRef.current, 880, .12, .5);
    setNewRec(null); setRunning(true);
  };

  const stopTimer = async () => {
    setRunning(false); vib([150]);
    beep(audioRef.current, 440, .18, .4);
    setTimeout(() => beep(audioRef.current, 330, .25, .3), 200);
    if (secs < 3) { setSecs(0); return; }
    const best = records.length ? Math.max(...records.map(r=>r.s)) : 0;
    const isRec = secs > best;
    const rec = { s:secs, date:fmtDate(), time:fmtTime(), rec:isRec };
    const upd = [rec, ...records];
    setRecords(upd); await store.set("fd5_records", upd);
    if (isRec) {
      setNewRec(rec); vib([80,40,80,40,250]);
      beep(audioRef.current,660,.12,.4);
      setTimeout(()=>beep(audioRef.current,880,.12,.4),160);
      setTimeout(()=>beep(audioRef.current,1100,.25,.4),320);
      await grantAch("pb");
    }
    for (const a of ACH_DEFS.filter(a=>a.type==="timer")) {
      if (secs >= a.thr) await grantAch(a.id);
    }
    setSecs(0);
  };

  const handleFitUpload = async (file, weekNum) => {
    if (!file) return;
    setFitLoading(true);
    try {
      const buf = await file.arrayBuffer();
      const parsed = parseFitFile(buf);
      if (!parsed) { alert("ĞĞµ Ğ²Ğ´Ğ°Ğ»Ğ¾ÑÑ Ñ€Ğ¾Ğ·Ğ¿Ğ°Ñ€ÑĞ¸Ñ‚Ğ¸ FIT Ñ„Ğ°Ğ¹Ğ»."); setFitLoading(false); return; }
      const updated = {...fitData, [weekNum]: parsed};
      setFitData(updated); await store.set("fd5_fit", updated);
      await grantAch("fit");
    } catch(e) { alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ Ñ„Ğ°Ğ¹Ğ»Ñƒ."); }
    setFitLoading(false);
  };

  const runAnalysis = async weekNum => {
    setAiLoading(true); setAiError(null);
    try {
      const plan = getPlan(weekNum);
      const result = await runAIAnalysis({
        week: weekNum,
        session: sessions[weekNum] || {},
        fitStats: fitData[weekNum]?.stats || null,
        planBlocks: plan.blocks,
        planGoals: plan.goals,
        blockNotes: bNotes,
        timerRecords: records,
        allSessions: sessions
      });
      const updated = {...aiCache, [weekNum]: result};
      setAiCache(updated); await store.set("fd5_ai", updated);
      if (result.suggestions?.length || result.goalSuggestions?.length) {
        setPendingPlan({week: weekNum, ...result});
      }
    } catch(e) { setAiError("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° AI: " + e.message); }
    setAiLoading(false);
  };

  const acceptPlan = async () => {
    if (!pendingPlan) return;
    const { week:w, suggestions=[], goalSuggestions=[] } = pendingPlan;
    const base = getPlan(w);
    const newBlocks = base.blocks.map(b => ({...b}));
    const newGoals  = {...base.goals};
    suggestions.forEach(s => { if (s.blockIndex>=0 && s.blockIndex<newBlocks.length) newBlocks[s.blockIndex][s.field] = s.proposed; });
    goalSuggestions.forEach(s => { newGoals[s.field] = s.proposed; });
    const updated = {...planAdj, [w]:{blocks:newBlocks, goals:newGoals}};
    setPlanAdj(updated); await store.set("fd5_padj", updated);
    setPendingPlan(null); await grantAch("plan");
  };

  const saveSession = async (w, data) => {
    const u = {...sessions, [w]: data}; setSessions(u); await store.set("fd5_sessions", u);
    setEditW(null); await grantAch("sess");
    const plan = getPlan(w);
    const allDone = plan.blocks.every((_,i) => checks[w+"_"+i]);
    if (allDone) await grantAch("blks");
    let streak = 0;
    for (let i=w; i>=1; i--) { if (u[i]?.completed) streak++; else break; }
    if (streak >= 3) await grantAch("cons");
    if (Object.values(u).filter(s=>s?.completed).length === 12) await grantAch("elite");
  };

  const toggleCheck = async k => {
    const u = {...checks, [k]: !checks[k]}; setChecks(u); await store.set("fd5_checks", u);
  };
  const updateBNote = async (k,v) => {
    const u = {...bNotes, [k]: v}; setBNotes(u); await store.set("fd5_bnotes", u);
  };

  const getPlan = w => {
    const adj = planAdj[w];
    if (!adj) return BASE_PLANS[w] || BASE_PLANS[1];
    return {...BASE_PLANS[w], ...adj};
  };

  const plan      = getPlan(week);
  const phaseObj  = PHASES.find(p => p.weeks.includes(week)) || PHASES[0];
  const best      = records.length ? Math.max(...records.map(r=>r.s)) : 0;
  const doneCount = Object.values(sessions).filter(s=>s?.completed).length;
  const TABS = [
    {id:"plan",     e:"ğŸ“‹", l:"ĞŸĞ»Ğ°Ğ½"},
    {id:"staticka", e:"â±",  l:"Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ĞºĞ°"},
    {id:"progress", e:"ğŸ“ˆ", l:"ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑ"},
    {id:"info",     e:"ğŸ’¡", l:"Ğ—Ğ½Ğ°Ğ½Ğ½Ñ"},
    {id:"rules",    e:"ğŸ“Œ", l:"ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ°"},
  ];

  if (!loaded) return (
    <div style={{background:"#050d1a",minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",color:"#38bdf8",fontFamily:"monospace",fontSize:18}}>
      Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...
    </div>
  );

  return (
    <div style={{background:"#050d1a",minHeight:"100vh",fontFamily:"Georgia,serif",color:"#e2e8f0",overflow:"hidden",position:"relative"}}>
      <style>{`
        @keyframes crownDrop{0%{transform:translate(-50%,-50%) rotate(var(--a)) translateY(0);opacity:1}60%{transform:translate(-50%,-50%) rotate(var(--a)) translateY(var(--dist))}100%{transform:translate(-50%,-50%) rotate(var(--a)) translateY(calc(var(--dist) + 10px)) scale(.3);opacity:0}}
        @keyframes rippleRing{0%{width:0;height:0;opacity:.8}100%{width:90px;height:28px;opacity:0}}
        @keyframes dropFall{0%{transform:translateY(-200px) scaleX(.85);opacity:0}20%{opacity:1}70%{transform:translateY(0) scaleX(.9)}82%{transform:translateY(10px) scaleX(1.35) scaleY(.18);opacity:.8}100%{transform:translateY(10px) scaleX(1.6) scaleY(0);opacity:0}}
        @keyframes introRipple{0%{width:4px;height:4px;opacity:.9}100%{width:150px;height:46px;opacity:0}}
        @keyframes introDone{0%{opacity:1}100%{opacity:0;pointer-events:none}}
        @keyframes rise{0%{transform:translateY(0);opacity:.5}100%{transform:translateY(-110vh);opacity:0}}
        @keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(56,189,248,.4)}50%{box-shadow:0 0 0 16px rgba(56,189,248,0)}}
        @keyframes pulseRed{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,.4)}50%{box-shadow:0 0 0 14px rgba(239,68,68,0)}}
        @keyframes glow{0%,100%{text-shadow:0 0 20px rgba(56,189,248,.3)}50%{text-shadow:0 0 40px rgba(56,189,248,.9)}}
        @keyframes achIn{0%{transform:translateX(110%);opacity:0}12%{transform:translateX(0);opacity:1}88%{transform:translateX(0);opacity:1}100%{transform:translateX(110%);opacity:0}}
        @keyframes pop{0%{transform:scale(.8);opacity:0}60%{transform:scale(1.06)}100%{transform:scale(1);opacity:1}}
        @keyframes spin{to{transform:rotate(360deg)}}
        input,textarea{background:rgba(255,255,255,.05);border:1px solid rgba(56,189,248,.2);color:#e2e8f0;border-radius:8px;padding:8px 12px;width:100%;font-family:Georgia,serif;font-size:14px}
        input:focus,textarea:focus{outline:none;border-color:rgba(56,189,248,.5)}
        .wbtn{transition:all .18s;cursor:pointer}.wbtn:hover{transform:scale(1.04)}
        ::-webkit-scrollbar{width:3px}::-webkit-scrollbar-thumb{background:rgba(56,189,248,.3);border-radius:4px}
      `}</style>

      {showIntro && <DropIntro onDone={() => setShowIntro(false)} />}
      <CrownSplash active={splash.active} color={splash.color} x={splash.x} y={splash.y} />

      {[...Array(10)].map((_,i) => (
        <div key={i} style={{position:"fixed",bottom:-8,left:`${4+i*10}%`,width:`${3+(i%3)*2}px`,height:`${3+(i%3)*2}px`,borderRadius:"50%",background:"rgba(56,189,248,.1)",border:"1px solid rgba(56,189,248,.2)",animation:`rise ${7+i*1.2}s ease-in infinite`,animationDelay:`${i*.65}s`,zIndex:0,pointerEvents:"none"}}/>
      ))}
      <div style={{position:"fixed",inset:0,background:"radial-gradient(ellipse at 20% 50%,rgba(14,116,144,.12) 0%,transparent 60%),radial-gradient(ellipse at 80% 20%,rgba(30,58,138,.15) 0%,transparent 50%)",zIndex:0,pointerEvents:"none"}}/>

      {/* Achievement toast */}
      {newAchQ[0] && (
        <div style={{position:"fixed",top:14,right:14,zIndex:9000,background:"rgba(8,18,36,.97)",border:"1px solid rgba(251,191,36,.4)",borderRadius:14,padding:"13px 16px",maxWidth:240,animation:"achIn 4s ease forwards",boxShadow:"0 8px 32px rgba(0,0,0,.6)"}}>
          <div style={{fontSize:22,marginBottom:3}}>{newAchQ[0].icon}</div>
          <div style={{color:"#fbbf24",fontSize:11,marginBottom:1}}>Ğ”Ğ¾ÑÑĞ³Ğ½ĞµĞ½Ğ½Ñ!</div>
          <div style={{color:"#f0f9ff",fontSize:12}}>{newAchQ[0].name}</div>
          <div style={{display:"flex",gap:2,marginTop:3}}>{getTiers(newAchQ[0].earnedCount||1).map(t=><span key={t.e} style={{fontSize:12}}>{t.e}</span>)}</div>
        </div>
      )}

      {/* New record toast */}
      {newRec && (
        <div style={{position:"fixed",top:newAchQ[0]?90:14,left:"50%",transform:"translateX(-50%)",zIndex:8900,background:"rgba(8,18,36,.97)",border:"1px solid rgba(251,191,36,.5)",borderRadius:14,padding:"13px 20px",textAlign:"center",animation:"pop .5s ease",boxShadow:"0 8px 32px rgba(251,191,36,.2)"}}>
          <div style={{fontSize:26,marginBottom:2}}>ğŸ…</div>
          <div style={{color:"#fbbf24",fontSize:13,marginBottom:1}}>ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ€ĞµĞºĞ¾Ñ€Ğ´!</div>
          <div style={{color:"#f0f9ff",fontSize:21,fontFamily:"monospace"}}>{fmt(newRec.s)}</div>
          <div style={{color:"#64748b",fontSize:10,marginTop:2}}>ĞœĞ¾Ğ»Ğ¾Ğ´ĞµÑ†ÑŒ, Ğ¡Ñ‚Ğ°Ğ½Ñ–ÑĞ»Ğ°Ğ²!</div>
          <button onClick={() => setNewRec(null)} style={{marginTop:6,background:"none",border:"none",color:"#334155",cursor:"pointer",fontSize:10}}>âœ•</button>
        </div>
      )}

      {/* Pending plan modal */}
      {pendingPlan && (
        <div style={{position:"fixed",inset:0,zIndex:200,background:"rgba(0,0,0,.9)",backdropFilter:"blur(8px)",display:"flex",alignItems:"center",justifyContent:"center",padding:14}}>
          <div style={{background:"#0a1628",border:"1px solid rgba(56,189,248,.3)",borderRadius:18,padding:22,maxWidth:440,width:"100%",maxHeight:"80vh",overflowY:"auto",animation:"pop .3s ease"}}>
            <div style={{fontSize:10,letterSpacing:3,color:"#38bdf8",textTransform:"uppercase",marginBottom:6}}>Jan Claude One Damn</div>
            <div style={{fontSize:16,color:"#f0f9ff",marginBottom:14}}>ĞŸÑ€Ğ¾Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ñ–Ñ ĞºĞ¾Ñ€ĞµĞºÑ†Ñ–Ñ— Ğ¿Ğ»Ğ°Ğ½Ñƒ</div>
            {[...(pendingPlan.goalSuggestions||[]).map(s=>({...s,isGoal:true})), ...(pendingPlan.suggestions||[]).map(s=>({...s,isGoal:false}))].map((s,i) => (
              <div key={i} style={{background:"rgba(255,255,255,.03)",border:"1px solid rgba(255,255,255,.07)",borderRadius:10,padding:11,marginBottom:9}}>
                <div style={{fontSize:10,color:"#38bdf8",marginBottom:3}}>Ğ¢Ğ¸Ğ¶Ğ´ĞµĞ½ÑŒ {s.targetWeek} â€” {s.isGoal?"Ğ¦Ñ–Ğ»ÑŒ":"Ğ‘Ğ»Ğ¾Ğº "+(s.blockIndex+1)}</div>
                <div style={{fontSize:11,color:"#475569",textDecoration:"line-through",marginBottom:2}}>Ğ‘ÑƒĞ»Ğ¾: {s.original}</div>
                <div style={{fontSize:12,color:"#4ade80",marginBottom:4}}>Ğ‘ÑƒĞ´Ğµ: {s.proposed}</div>
                <div style={{fontSize:10,color:"#64748b",fontStyle:"italic"}}>{s.reason}</div>
              </div>
            ))}
            <div style={{display:"flex",gap:9,marginTop:14}}>
            <button onClick={() => setPendingPlan(null)} style={{flex:1,padding:11,borderRadius:11,background:"rgba(239,68,68,.07)",border:"1px solid rgba(239,68,68,.2)",color:"#fca5a5",cursor:"pointer"}}>âœ• Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸</button>
              <button onClick={acceptPlan} style={{flex:2,padding:11,borderRadius:11,background:"linear-gradient(135deg,rgba(74,222,128,.18),rgba(14,116,144,.28))",border:"1px solid rgba(74,222,128,.3)",color:"#4ade80",cursor:"pointer"}}>âœ“ ĞŸÑ€Ğ¸Ğ¹Ğ½ÑÑ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸</button>
            </div>
          </div>
        </div>
      )}

      <div style={{position:"relative",zIndex:1,maxWidth:480,margin:"0 auto",paddingBottom:80}}>

        {/* Header */}
        <div style={{padding:"22px 16px 12px",textAlign:"center"}}>
          <div style={{fontSize:9,letterSpacing:4,color:"#38bdf8",textTransform:"uppercase",marginBottom:4}}>Freediving Tracker</div>
          <h1 style={{margin:0,fontSize:21,fontWeight:"normal",color:"#f0f9ff"}}>Ğ¡Ñ‚Ğ°Ğ½Ñ–ÑĞ»Ğ°Ğ² Ğ“Ğ¾Ğ¹ÑĞ°Ğ½</h1>
          <div style={{fontSize:10,color:"#475569",marginTop:3}}>Ğ‘Ğ°ÑĞµĞ¹Ğ½ 25Ğ¼ Â· Ğ©Ğ¾ÑÑƒĞ±Ğ¾Ñ‚Ğ¸ 12:00 Â· 3.8Ğ¼</div>
          <div style={{marginTop:11,background:"rgba(255,255,255,.04)",borderRadius:100,height:4,overflow:"hidden"}}>
            <div style={{height:"100%",width:`${(doneCount/12)*100}%`,background:"linear-gradient(90deg,#0ea5e9,#38bdf8,#7dd3fc)",borderRadius:100,transition:"width .5s",boxShadow:"0 0 10px rgba(56,189,248,.4)"}}/>
          </div>
          <div style={{marginTop:3,fontSize:10,color:"#475569"}}>{doneCount}/12 Ñ‚Ñ€ĞµĞ½ÑƒĞ²Ğ°Ğ½ÑŒ Â· Ğ ĞµĞºĞ¾Ñ€Ğ´ ÑÑ‚Ğ°Ñ‚Ğ¸ĞºĞ¸: {best>0?fmt(best):"â€”"}</div>
        </div>

        {/* Tabs */}
        <div style={{display:"flex",gap:2,margin:"0 14px 14px",background:"rgba(255,255,255,.03)",borderRadius:13,padding:3,border:"1px solid rgba(255,255,255,.06)"}}>
          {TABS.map(t => (
            <button key={t.id} onClick={e=>{setTab(t.id);triggerSplash(e,"#38bdf8");}} style={{flex:1,padding:"7px 2px",border:"none",borderRadius:10,background:tab===t.id?"rgba(56,189,248,.12)":"transparent",color:tab===t.id?"#38bdf8":"#475569",fontSize:9,cursor:"pointer",display:"flex",flexDirection:"column",alignItems:"center",gap:1,borderBottom:tab===t.id?"2px solid #38bdf8":"2px solid transparent",transition:"all .2s"}}>
              <span style={{fontSize:16}}>{t.e}</span><span>{t.l}</span>
            </button>
          ))}
        </div>

        {/* â”€â”€ PLAN â”€â”€ */}
        {tab==="plan" && (
          <div style={{padding:"0 14px",animation:"fadeUp .3s ease"}}>
            {/* Phases */}
            <div style={{display:"flex",gap:7,marginBottom:13}}>
              {PHASES.map(ph => {
                const active = phase===ph.id;
                return (
                  <button key={ph.id} className="wbtn" onClick={e=>{setPhase(ph.id);setWeek(ph.weeks[0]);triggerSplash(e,ph.color);}} style={{flex:1,padding:"10px 4px",border:`1px solid ${active?ph.color:"rgba(255,255,255,.07)"}`,borderRadius:12,background:active?`rgba(${ph.rgb},.07)`:"rgba(255,255,255,.02)",color:active?ph.color:"#475569",fontSize:11,cursor:"pointer",textAlign:"center"}}>
                    <div style={{fontWeight:"bold",marginBottom:1}}>{ph.name}</div>
                    <div style={{opacity:.7,fontSize:9}}>{ph.subtitle}</div>
                    <div style={{opacity:.5,fontSize:8}}>Ğ¢Ğ¸Ğ¶Ğ½Ñ– {ph.weeks[0]}â€“{ph.weeks[ph.weeks.length-1]}</div>
                  </button>
                );
              })}
            </div>
            {/* Weeks */}
            <div style={{display:"flex",gap:7,marginBottom:13}}>
              {PHASES.find(p=>p.id===phase)?.weeks.map(w => {
                const isDone=sessions[w]?.completed, isAct=week===w;
                return (
                  <button key={w} className="wbtn" onClick={e=>{setWeek(w);triggerSplash(e,phaseObj.color);}} style={{flex:1,height:46,borderRadius:10,background:isAct?"rgba(56,189,248,.14)":isDone?"rgba(74,222,128,.07)":"rgba(255,255,255,.02)",border:isAct?"2px solid #38bdf8":isDone?"1px solid rgba(74,222,128,.3)":"1px solid rgba(255,255,255,.
                  07)",color:isAct?"#38bdf8":isDone?"#4ade80":"#64748b",fontSize:13,fontWeight:"bold",cursor:"pointer",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:1}}>
                    <span>{w}</span>{isDone&&<span style={{fontSize:8}}>âœ“</span>}
                  </button>
                );
              })}
            </div>

            {plan && (
              <>
                <div style={{background:"rgba(255,255,255,.02)",border:`1px solid rgba(${phaseObj.rgb},.18)`,borderRadius:15,padding:14,marginBottom:10}}>
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:10}}>
                    <div>
                      <div style={{fontSize:17,color:"#f0f9ff"}}>Ğ¢Ğ¸Ğ¶Ğ´ĞµĞ½ÑŒ {week}</div>
                      <div style={{fontSize:10,color:phaseObj.color,marginTop:2}}>{phaseObj.name} â€” {phaseObj.subtitle}</div>
                      {planAdj[week] && <div style={{fontSize:8,color:"#38bdf8",marginTop:2}}>âœ¦ Ğ¡ĞºĞ¾Ñ€ĞµĞ³Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ AI</div>}
                    </div>
                    {sessions[week]?.completed && (
                      <div style={{background:"rgba(74,222,128,.1)",border:"1px solid rgba(74,222,128,.3)",color:"#4ade80",padding:"2px 9px",borderRadius:100,fontSize:10}}>âœ“ Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾</div>
                    )}
                  </div>

                  {/* Goals â€” Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ĞºĞ° is a deeplink */}
                  <div style={{display:"flex",gap:6,marginBottom:12}}>
                    {[{e:"â±",l:"Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ĞºĞ°",v:plan.goals.s,link:true},{e:"ğŸŠ",l:"Ğ”Ğ¸Ğ½Ğ°Ğ¼Ñ–ĞºĞ°",v:plan.goals.d},{e:"ğŸ¤¿",l:"Ğ“Ğ»Ğ¸Ğ±Ğ¸Ğ½Ğ°",v:plan.goals.g}].map((g,i) => (
                      <div key={i} onClick={g.link ? e=>{setTab("staticka");triggerSplash(e,"#38bdf8");} : undefined}
                        className={g.link?"wbtn":""}
                        style={{flex:1,background:`rgba(${phaseObj.rgb},.05)`,border:`1px solid rgba(${phaseObj.rgb},.12)`,borderRadius:9,padding:"8px 4px",textAlign:"center",cursor:g.link?"pointer":"default"}}>
                        <div style={{fontSize:13,marginBottom:2}}>{g.e}</div>
                        <div style={{fontSize:8,color:"#64748b",marginBottom:1}}>{g.l}</div>
                        <div style={{fontSize:8,color:phaseObj.color,lineHeight:1.3}}>{g.v}</div>
                        {g.link && <div style={{fontSize:7,color:"#38bdf8",marginTop:2}}>â†’ Ğ¢Ğ°Ğ¹Ğ¼ĞµÑ€</div>}
                      </div>
                    ))}
                  </div>

                  {/* Blocks */}
                  {plan.blocks.map((b,i) => {
                    const ck=week+"_"+i, isDone=!!checks[ck], nk=week+"_n_"+i, nv=bNotes[nk]||"";
                    return (
                      <div key={i} style={{background:isDone?"rgba(74,222,128,.04)":"rgba(255,255,255,.01)",border:isDone?"1px solid rgba(74,222,128,.18)":"1px solid rgba(255,255,255,.05)",borderRadius:9,padding:"10px 11px",marginBottom:7,transition:"all .2s"}}>
                        <div style={{display:"flex",alignItems:"flex-start",gap:8}}>
                          <button onClick={()=>toggleCheck(ck)} style={{width:20,height:20,minWidth:20,borderRadius:5,border:isDone?"2px solid #4ade80":"2px solid rgba(255,255,255,.2)",background:isDone?"rgba(74,222,128,.15)":"transparent",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",marginTop:1,transition:"all .2s",color:"#4ade80",fontSize:11}}>
                            {isDone?"âœ“":""}
                          </button>
                          <div style={{flex:1}}>
                            <div style={{display:"flex",justifyContent:"space-between",marginBottom:2}}>
                              <span style={{color:isDone?"#4ade80":"#e2e8f0",fontSize:12,opacity:isDone?.65:1,textDecoration:isDone?"line-through":"none"}}>{b.n}</span>
                              <span style={{color:"#475569",fontSize:10}}>{b.t}</span>
                            </div>
                            <div style={{color:"#64748b",fontSize:11,lineHeight:1.5,marginBottom:5}}>{b.d}</div>
                            <textarea rows={1} placeholder="ĞĞ¾Ñ‚Ğ°Ñ‚ĞºĞ¸ Ğ´Ğ¾ Ğ±Ğ»Ğ¾ĞºÑƒ..." value={nv} onChange={e=>updateBNote(nk,e.target.value)} style={{resize:"vertical",minHeight:27,fontSize:10,color:"#94a3b8",borderColor:"rgba(255,255,255,.06)",padding:"4px 8px"}}/>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                  <div style={{background:"rgba(251,191,36,.04)",border:"1px solid rgba(251,191,36,.15)",borderRadius:8,padding:"8px 11px",fontSize:11,color:"#fbbf24",marginTop:3}}>ğŸ’¡ {plan.tip}</div>
                </div>

                {!sessions[week]?.completed
                  ? <button className="wbtn" onClick={e=>{triggerSplash(e,phaseObj.color);setEditW({week,...(sessions[week]||{completed:false,date:"",staticTime:"",dynamicDist:"",avgHR:"",maxHR:"",notes:"",feeling:""})});}} style={{width:"100%",padding:11,borderRadius:11,background:`linear-gradient(135deg,rgba(${phaseObj.rgb},.18),rgba(30,58,138,.28))`,border:`1px solid rgba(${phaseObj.rgb},.3)`,color:phaseObj.color,fontSize:13,cursor:"pointer",marginBottom:9}}>+ Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚Ğ¸ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ñ‚Ñ€ĞµĞ½ÑƒĞ²Ğ°Ğ½Ğ½Ñ</button>
                  : <button className="wbtn" onClick={e=>{triggerSplash(e,"#4ade80");setEditW({week,...sessions[week]});}} style={{width:"100%",padding:11,borderRadius:11,background:"rgba(74,222,128,.04)",border:"1px solid rgba(74,222,128,.2)",color:"#4ade80",fontSize:12,cursor:"pointer",marginBottom:9}}>âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ·Ğ°Ğ¿Ğ¸Ñ</button>
                }

                {/* AI Analysis */}
                {sessions[week]?.completed && (
                  <div style={{background:"rgba(14,30,58,.6)",border:"1px solid rgba(56,189,248,.2)",borderRadius:13,padding:14,marginBottom:9}}>
                    <div style={{fontSize:9,letterSpacing:3,color:"#38bdf8",textTransform:"uppercase",marginBottom:8}}>ğŸ¤– Jan Claude One Damn</div>
                    {fitData[week] && (
                      <div style={{background:"rgba(56,189,248,.04)",border:"1px solid rgba(56,189,248,.1)",borderRadius:9,padding:9,marginBottom:9}}>
                        <div style={{fontSize:9,color:"#38bdf8",marginBottom:5}}>ğŸ“ˆ HR â€” Garmin Descend MK2S</div>
                        <HRChart pts={fitData[week].pts} color="#38bdf8"/>
                        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:5,marginTop:7}}>
                          {[{l:"Avg HR",v:fitData[week].stats.avg},{l:"Max HR",v:fitData[week].stats.max},{l:"Min HR",v:fitData[week].stats.min}].map((s,i)=>(
                            <div key={i} style={{textAlign:"center",background:"rgba(255,255,255,.03)",borderRadius:6,padding:"5px 3px"}}>
                              <div style={{fontSize:13,color:s.l==="Max HR"&&s.v>120?"#f87171":s.l==="Min HR"&&s.v<85?"#4ade80":"#e2e8f0"}}>{s.v||"â€”"}</div>
                              <div style={{fontSize:8,color:"#475569"}}>{s.l}</div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                    {aiCache[week] && (
                      <div style={{animation:"fadeUp .3s ease"}}>
                        <div style={{background:aiCache[week].verdict==="critical"?"rgba(239,68,68,.06)":aiCache[week].verdict==="warning"?"rgba(251,191,36,.06)":"rgba(74,222,128,.04)",border:`1px solid ${aiCache[week].verdict==="critical"?"rgba(239,68,68,.2)":aiCache[week].verdict==="warning"?"rgba(251,191,36,.2)":"rgba(74,222,128,.15)"}`,borderRadius:9,padding:11,marginBottom:9}}>
                          <div style={{fontSize:11,color:"#94a3b8",lineHeight:1.7}}>{aiCache[week].analysis}</div>
                        </div>
                        {(aiCache[week].suggestions?.length||aiCache[week].goalSuggestions?.length) > 0 && !planAdj[week] && (
                          <button className="wbtn" onClick={()=>setPendingPlan({week,...aiCache[week]})} style={{width:"100%",padding:9,borderRadius:9,background:"rgba(56,189,248,.07)",border:"1px solid rgba(56,189,248,.22)",color:"#38bdf8",fontSize:11,cursor:"pointer",marginBottom:7}}>
                            ğŸ“‹ ĞŸĞµÑ€ĞµĞ³Ğ»ÑĞ½ÑƒÑ‚Ğ¸ Ğ¿Ñ€Ğ¾Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ñ–Ñ— ĞºĞ¾Ñ€ĞµĞºÑ†Ñ–Ñ— Ğ¿Ğ»Ğ°Ğ½Ñƒ
                          </button>
                        )}
                        {planAdj[week] && <div style={{fontSize:10,color:"#4ade80",textAlign:"center",marginBottom:7}}>âœ“ ĞŸĞ»Ğ°Ğ½ ÑĞºĞ¾Ñ€ĞµĞ³Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹</div>}
                      </div>
                    )}
                    {aiError && <div style={{color:"#fca5a5",fontSize:10,marginBottom:7}}>{aiError}</div>}
                    <button className="wbtn" onClick={()=>runAnalysis(week)} disabled={aiLoading} style={{width:"100%",padding:9,borderRadius:9,background:aiLoading?"rgba(255,255,255,.02)":"rgba(56,189,248,.09)",border:"1px solid rgba(56,189,248,.22)",color:aiLoading?"#475569":"#38bdf8",fontSize:11,cursor:aiLoading?"not-allowed":"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:7}}>
                      {aiLoading ? <><div style={{width:13,height:13,border:"2px solid #38bdf8",borderTopColor:"transparent",borderRadius:"50%",animation:"spin 1s linear infinite"}}/>ĞĞ½Ğ°Ğ»Ñ–Ğ·ÑƒÑ...</> : "ğŸ” ĞĞ½Ğ°Ğ»Ñ–Ğ· Ğ²Ñ–Ğ´ Jan Claude One Damn"}
                    </button>
                  </div>
                )}
              </>
            )}
          </div>
        )}

        {/* â”€â”€ Ğ¡Ğ¢ĞĞ¢Ğ˜ĞšĞ â”€â”€ */}
        {tab==="staticka" && (
          <div style={{padding:"0 14px",animation:"fadeUp .3s ease"}}>
            {/* Timer */}
            <div style={{background:"rgba(255,255,255,.02)",border:"1px solid rgba(56,189,248,.15)",borderRadius:18,padding:"24px 14px",marginBottom:14,textAlign:"center"}}>
              <div style={{fontSize:9,letterSpacing:3,color:"#475569",textTransform:"uppercase",marginBottom:11}}>Ğ¡Ñ‚Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğ° Ğ·Ğ°Ñ‚Ñ€Ğ¸Ğ¼ĞºĞ° Ğ´Ğ¸Ñ…Ğ°Ğ½Ğ½Ñ</div>
              <div style={{fontSize:62,fontFamily:"monospace",color:running?"#38bdf8":"#f0f9ff",letterSpacing:4,lineHeight:1,marginBottom:5,animation:running?"glow 2s ease infinite":"none"}}>{fmt(secs)}</div>
              {best>0 && (
                <div style={{fontSize:11,color:"#475569",marginBottom:14}}>
                  Ğ ĞµĞºĞ¾Ñ€Ğ´: <span style={{color:"#fbbf24"}}>{fmt(best)}</span>
                  {running && secs<best && <span style={{color:"#64748b"}}> Â· Ñ‰Ğµ {fmt(best-secs)}</span>}
                  {running && secs>=best && <span style={{color:"#4ade80"}}> ğŸ”¥ Ğ ĞµĞºĞ¾Ñ€Ğ´!</span>}
                </div>
              )}
              {!running
                ? <button onClick={startTimer} style={{width:120,height:120,borderRadius:"50%",background:"linear-gradient(135deg,rgba(14,116,144,.4),rgba(30,58,138,.5))",border:"3px solid rgba(56,189,248,.5)",color:"#38bdf8",fontSize:14,cursor:"pointer",animation:"pulse 2s ease infinite",display:"inline-flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:4}}>
                    <span style={{fontSize:28}}>ğŸ¤¿</span><span>Ğ¡Ğ¢ĞĞ Ğ¢</span>
                  </button>
                : <button onClick={stopTimer} style={{width:120,height:120,borderRadius:"50%",background:"linear-gradient(135deg,rgba(239,68,68,.3),rgba(185,28,28,.4))",border:"3px solid rgba(239,68,68,.5)",color:"#fca5a5",fontSize:14,cursor:"pointer",animation:"pulseRed 1.2s ease infinite",display:"inline-flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:4}}>
                    <span style={{fontSize:28}}>âœ‹</span><span>Ğ¡Ğ¢ĞĞŸ</span>
                  </button>
              }
              <div style={{marginTop:11,fontSize:10,color:"#334155"}}>{running?"ĞĞ°Ñ‚Ğ¸ÑĞ½Ğ¸ Ğ¡Ğ¢ĞĞŸ ĞºĞ¾Ğ»Ğ¸ Ğ·Ğ°Ñ…Ğ¾Ñ‡ĞµÑˆ Ğ²Ğ¸Ğ´Ğ¸Ñ…Ğ½ÑƒÑ‚Ğ¸":"ĞĞ°Ñ‚Ğ¸ÑĞ½Ğ¸ Ğ¡Ğ¢ĞĞ Ğ¢ Ğ¿ĞµÑ€ĞµĞ´ Ğ·Ğ°Ñ‚Ñ€Ğ¸Ğ¼ĞºĞ¾Ñ"}</div>
            </div>

            {/* History toggle */}
            {records.length > 0 && (
              <div style={{marginBottom:13}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
                  <div style={{fontSize:9,letterSpacing:3,color:"#475569",textTransform:"uppercase"}}>Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ·Ğ°Ñ‚Ñ€Ğ¸Ğ¼Ğ¾Ğº</div>
                  <div style={{display:"flex",gap:4}}>
                    {["chart","table"].map(v => (<button key={v} onClick={()=>setHistView(v)} style={{padding:"3px 10px",borderRadius:20,border:`1px solid ${histView===v?"rgba(56,189,248,.4)":"rgba(255,255,255,.07)"}`,background:histView===v?"rgba(56,189,248,.12)":"transparent",color:histView===v?"#38bdf8":"#475569",fontSize:9,cursor:"pointer"}}>
                        {v==="chart"?"ğŸ“ˆ Ğ“Ñ€Ğ°Ñ„Ñ–Ğº":"ğŸ“‹ Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ"}
                      </button>
                    ))}
                  </div>
                </div>

                {histView==="chart" && (
                  <div style={{background:"rgba(255,255,255,.02)",border:"1px solid rgba(56,189,248,.12)",borderRadius:12,padding:"12px 10px"}}>
                    <div style={{fontSize:10,color:"#475569",marginBottom:6}}>ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑ ÑÑ‚Ğ°Ñ‚Ğ¸ĞºĞ¸ Â· ğŸ… = Ñ€ĞµĞºĞ¾Ñ€Ğ´</div>
                    <StaticHistoryChart records={records}/>
                    {/* Stats row */}
                    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:6,marginTop:10}}>
                      {[
                        {l:"Ğ ĞµĞºĞ¾Ñ€Ğ´",v:fmt(best),c:"#fbbf24"},
                        {l:"Ğ¡ĞµÑ€ĞµĞ´Ğ½Ñ”",v:fmt(Math.round(records.reduce((a,r)=>a+r.s,0)/records.length)),c:"#38bdf8"},
                        {l:"Ğ¡ĞµÑÑ–Ğ¹",v:records.length,c:"#94a3b8"},
                        {l:"Ğ ĞµĞºĞ¾Ñ€Ğ´Ñ–Ğ²",v:records.filter(r=>r.rec).length,c:"#4ade80"},
                      ].map((s,i) => (
                        <div key={i} style={{textAlign:"center",background:"rgba(255,255,255,.03)",borderRadius:7,padding:"6px 3px"}}>
                          <div style={{fontSize:13,color:s.c,fontFamily:"monospace"}}>{s.v}</div>
                          <div style={{fontSize:8,color:"#475569",marginTop:1}}>{s.l}</div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {histView==="table" && (
                  <div style={{background:"rgba(255,255,255,.02)",border:"1px solid rgba(255,255,255,.06)",borderRadius:12,overflow:"hidden"}}>
                    <div style={{display:"grid",gridTemplateColumns:"24px 1fr auto auto",borderBottom:"1px solid rgba(255,255,255,.05)"}}>
                      {["#","Ğ§Ğ°Ñ","Ğ”Ğ°Ñ‚Ğ°",""].map((h,i) => (
                        <div key={i} style={{padding:"7px 9px",fontSize:8,color:"#475569",letterSpacing:1,textTransform:"uppercase"}}>{h}</div>
                      ))}
                    </div>
                    {records.slice(0,25).map((r,i) => (
                      <div key={i} style={{display:"grid",gridTemplateColumns:"24px 1fr auto auto",borderBottom:"1px solid rgba(255,255,255,.03)",background:i%2?"rgba(255,255,255,.01)":"transparent"}}>
                        <div style={{padding:"8px 9px",fontSize:10,color:"#334155"}}>{i+1}</div>
                        <div style={{padding:"8px 9px",fontSize:16,fontFamily:"monospace",color:r.rec?"#fbbf24":"#e2e8f0",display:"flex",alignItems:"center",gap:4}}>
                          {fmt(r.s)}{r.rec && <span style={{fontSize:10}}>ğŸ…</span>}
                        </div>
                        <div style={{padding:"8px 7px",fontSize:9,color:"#475569",lineHeight:1.4}}>{r.date}<br/>{r.time}</div>
                        <div style={{padding:"8px 7px",display:"flex",alignItems:"center"}}>
                          <button onClick={async()=>{const u=records.filter((_,idx)=>idx!==i);setRecords(u);await store.set("fd5_records",u);}} style={{background:"none",border:"none",color:"#374151",cursor:"pointer",fontSize:12}}>âœ•</button>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}

            {/* Achievements */}
            <div style={{marginBottom:13}}>
              <div style={{fontSize:9,letterSpacing:3,color:"#475569",textTransform:"uppercase",marginBottom:9}}>Ğ”Ğ¾ÑÑĞ³Ğ½ĞµĞ½Ğ½Ñ <span style={{color:"#334155",fontWeight:"normal"}}>(Ğ½Ğ°Ñ‚Ğ¸ÑĞ½Ğ¸ Ğ´Ğ»Ñ Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹)</span></div>
              <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:6}}>
                {ACH_DEFS.map(a => <AchBadge key={a.id} def={a} count={achCounts[a.id]||0}/>)}
              </div>
              {/* Cup legend */}
              <div style={{display:"flex",gap:12,justifyContent:"center",marginTop:9,padding:"7px 10px",background:"rgba(255,255,255,.02)",borderRadius:9}}>
                {[{e:"ğŸ¥‰",n:"Ğ‘Ñ€Ğ¾Ğ½Ğ·Ğ°",r:"1â€“10"},{e:"ğŸ¥ˆ",n:"Ğ¡Ñ€Ñ–Ğ±Ğ»Ğ¾",r:"11â€“50"},{e:"ğŸ¥‡",n:"Ğ—Ğ¾Ğ»Ğ¾Ñ‚Ğ¾",r:"51â€“99"},{e:"ğŸ†",n:"ĞŸĞ»Ğ°Ñ‚Ğ¸Ğ½Ğ°",r:"100+"}].map(t => (
                  <div key={t.e} style={{textAlign:"center"}}>
                    <div style={{fontSize:16}}>{t.e}</div>
                    <div style={{fontSize:8,color:"#64748b"}}>{t.r}</div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}

        {/* â”€â”€ PROGRESS â”€â”€ */}
        {tab==="progress" && (
          <div style={{padding:"0 14px",animation:"fadeUp .3s ease"}}>
            <div style={{display:"flex",gap:7,marginBottom:14}}>
              {[{l:"Ğ¢Ñ€ĞµĞ½ÑƒĞ²Ğ°Ğ½ÑŒ",v:`${doneCount}/12`,e:"âœ…"},{l:"Ğ ĞµĞºĞ¾Ñ€Ğ´ ÑÑ‚Ğ°Ñ‚Ğ¸ĞºĞ¸",v:best>0?fmt(best):"â€”",e:"ğŸ…"},{l:"Ğ¡ĞµÑÑ–Ğ¹ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ğ°",v:records.length,e:"â±"}].map((s,i) => (
                <div key={i} style={{flex:1,background:"rgba(255,255,255,.02)",border:"1px solid rgba(255,255,255,.06)",borderRadius:11,padding:"11px 6px",textAlign:"center"}}>
                  <div style={{fontSize:18,marginBottom:2}}>{s.e}</div>
                  <div style={{fontSize:15,color:"#38bdf8",marginBottom:2}}>{s.v}</div>
                  <div style={{fontSize:8,color:"#475569"}}>{s.l}</div>
                </div>
              ))}
            </div>

            {/* Session history chart */}
            {doneCount >= 2 && (
              <div style={{background:"rgba(255,255,255,.02)",border:"1px solid rgba(74,222,128,.12)",borderRadius:12,padding:"12px 10px",marginBottom:13}}>
                <div style={{fontSize:9,color:"#4ade80",marginBottom:6,letterSpacing:2,textTransform:"uppercase"}}>ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑ ÑÑ‚Ğ°Ñ‚Ğ¸ĞºĞ¸ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¶Ğ½ÑÑ…</div>
                <SessionHistoryChart sessions={sessions}/>
              </div>
            )}

            <div style={{fontSize:9,letterSpacing:3,color:"#475569",textTransform:"uppercase",marginBottom:9}}>Ğ–ÑƒÑ€Ğ½Ğ°Ğ» Ñ‚Ñ€ĞµĞ½ÑƒĞ²Ğ°Ğ½ÑŒ</div>
            {Object.keys(sessions).length===0
              ? <div style={{background:"rgba(255,255,255,.02)",border:"1px dashed rgba(255,255,255,.06)",borderRadius:11,padding:24,textAlign:"center",color:"#475569",fontSize:12}}>Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ–Ğ² Ğ¿Ğ¾ĞºĞ¸ Ğ½ĞµĞ¼Ğ°Ñ”.<br/>Ğ—Ğ°Ğ¿Ğ¸ÑˆĞ¸ Ğ¿ĞµÑ€ÑˆĞµ Ñ‚Ñ€ĞµĞ½ÑƒĞ²Ğ°Ğ½Ğ½Ñ!</div>
              : [...Array(12)].map((_,i) => {
                  const w=i+1, s=sessions[w];
                  if (!s?.completed) return null;
                  return (
                    <div key={w} style={{background:"rgba(74,222,128,.02)",border:"1px solid rgba(74,222,128,.1)",borderRadius:11,padding:12,marginBottom:7}}>
                      <div style={{display:"flex",justifyContent:"space-between",marginBottom:5}}>
                        <span style={{color:"#4ade80",fontSize:12}}>Ğ¢Ğ¸Ğ¶Ğ´ĞµĞ½ÑŒ {w}</span>
                        <span style={{color:"#475569",fontSize:10}}>{s.date}</span>
                      </div>
                      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:4}}>
                        {s.staticTime  && <div style={{fontSize:10}}><span style={{color:"#475569"}}>Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ĞºĞ°: </span><span>{s.staticTime}</span></div>}
                        {s.dynamicDist && <div style={{fontSize:10}}><span style={{color:"#475569"}}>Ğ”Ğ¸Ğ½Ğ°Ğ¼Ñ–ĞºĞ°: </span><span>{s.dynamicDist}</span></div>}
                        {s.avgHR       && <div style={{fontSize:10}}><span style={{color:"#475569"}}>Avg HR: </span><span>{s.avgHR}</span></div>}
                        {s.maxHR       && <div style={{fontSize:10}}><span style={{color:"#475569"}}>Max HR: </span><span>{s.maxHR}</span></div>}
                      </div>
                      {s.feeling && <div style={{marginTop:4,fontSize:10,color:"#64748b"}}>Ğ¡Ğ°Ğ¼Ğ¾Ğ¿Ğ¾Ñ‡ÑƒÑ‚Ñ‚Ñ: {s.feeling}</div>}
                      {s.notes   && <div style={{marginTop:3,fontSize:10,color:"#64748b",fontStyle:"italic"}}>"{s.notes}"</div>}
                      <div style={{display:"flex",gap:6,marginTop:5}}>
                        {fitData[w] && <div style={{fontSize:9,color:"#38bdf8"}}>ğŸ“Š HR avg {fitData[w].stats.avg}/{fitData[w].stats.max}</div>}
                        {aiCache[w] && <div style={{fontSize:9,color:"#a78bfa"}}>ğŸ¤– AI Ğ°Ğ½Ğ°Ğ»Ñ–Ğ·</div>}
                      </div>
                    </div>
                  );
                })
            }
          </div>
        )}

        {/* â”€â”€ INFO â”€â”€ */}
        {tab==="info" && (
          <div style={{padding:"0 14px",animation:"fadeUp .3s ease"}}>
            <div style={{fontSize:9,letterSpacing:3,color:"#475569",textTransform:"uppercase",marginBottom:11}}>Ğ¢ĞµÑ…Ğ½Ñ–ĞºĞ¸ Ñ– Ğ·Ğ½Ğ°Ğ½Ğ½Ñ</div>
            {INFO_DATA.map((card,idx) => <InfoCard key={idx} card={card}/>)}
          </div>
        )}

        {/* â”€â”€ RULES â”€â”€ */}
        {tab==="rules" && (
          <div style={{padding:"0 14px",animation:"fadeUp .3s ease"}}>
            {[
              {title:"Ğ—Ğ¾Ğ»Ğ¾Ñ‚Ñ– Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°",color:"rgba(56,189,248,.05)",border:"rgba(56,189,248,.15)",tc:"#e2e8f0",items:["ğŸ’§ 500Ğ¼Ğ» Ğ²Ğ¾Ğ´Ğ¸ Ğ·Ğ° 30 Ñ…Ğ² Ğ´Ğ¾ Ñ‚Ñ€ĞµĞ½ÑƒĞ²Ğ°Ğ½Ğ½Ñ","â¤ï¸ ĞŸÑƒĞ»ÑŒÑ < 85 Ğ¿ĞµÑ€ĞµĞ´ ĞºĞ¾Ğ¶Ğ½Ğ¸Ğ¼ Ğ·Ğ°Ğ½ÑƒÑ€ĞµĞ½Ğ½ÑĞ¼","ğŸ˜´ Ğ¡Ñ‚Ñ€ĞµÑ Ğ°Ğ±Ğ¾ Ğ¿Ğ¾Ğ³Ğ°Ğ½Ğ¸Ğ¹ ÑĞ¾Ğ½ â€” Ğ·Ğ½Ğ¸Ğ¶ÑƒĞ¹ Ñ–Ğ½Ñ‚ĞµĞ½ÑĞ¸Ğ²Ğ½Ñ–ÑÑ‚ÑŒ Ğ²Ğ´Ğ²Ñ–Ñ‡Ñ–","ğŸ¯ ĞĞµ Ğ±Ñ–Ğ»ÑŒÑˆĞµ 1 Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ·ÑƒÑĞ¸Ğ»Ğ»Ñ Ğ·Ğ° Ñ‚Ñ€ĞµĞ½ÑƒĞ²Ğ°Ğ½Ğ½Ñ","ğŸ‘¤ Ğ—Ğ°Ğ²Ğ¶Ğ´Ğ¸ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ÑĞ¹ ĞºĞ¾Ğ³Ğ¾ÑÑŒ","ğŸš¨ Ğ‘ÑƒĞ´ÑŒ-ÑĞºĞ¸Ğ¹ Ğ´Ğ¸ÑĞºĞ¾Ğ¼Ñ„Ğ¾Ñ€Ñ‚ â€” Ğ½ĞµĞ³Ğ°Ğ¹Ğ½Ğ¾ Ğ²Ğ¸Ñ…Ğ¾Ğ´ÑŒ"]},
              {title:"Ğ¡ĞµÑ€Ñ†Ğµ: Ğ¿Ñ€Ğ¾Ğ»Ğ°Ğ¿Ñ ĞœĞš 1 ÑÑ‚.",color:"rgba(239,68,68,.04)",border:"rgba(239,68,68,.18)",tc:"#fca5a5",items:["ğŸš© Ğ¡ĞµÑ€Ñ†ĞµĞ±Ğ¸Ñ‚Ñ‚Ñ, Ğ±Ñ–Ğ»ÑŒ Ñƒ Ğ³Ñ€ÑƒĞ´ÑÑ… â€” Ğ¡Ğ¢ĞĞŸ","â± ĞŸÑƒĞ»ÑŒÑ < 85 Ğ¿ĞµÑ€ĞµĞ´ ĞºĞ¾Ğ¶Ğ½Ğ¸Ğ¼ Ğ·Ğ°Ğ½ÑƒÑ€ĞµĞ½Ğ½ÑĞ¼","ğŸ’§ Ğ”ĞµĞ³Ñ–Ğ´Ñ€Ğ°Ñ‚Ğ°Ñ†Ñ–Ñ Ğ¿Ñ–Ğ´Ğ²Ğ¸Ñ‰ÑƒÑ” Ñ€Ğ¸Ğ·Ğ¸Ğº Ğ°Ñ€Ğ¸Ñ‚Ğ¼Ñ–Ğ¹","ğŸ˜¤ Ğ“Ñ–Ğ¿ĞµÑ€Ğ²ĞµĞ½Ñ‚Ğ¸Ğ»ÑÑ†Ñ–Ñ Ğ¿ĞµÑ€ĞµĞ´ Ğ¿Ñ–Ñ€Ğ½Ğ°Ğ½Ğ½ÑĞ¼ â€” Ğ—ĞĞ‘ĞĞ ĞĞĞ•ĞĞ"]},
              {title:"ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ Ğ²Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½ĞºÑƒ",color:"rgba(251,191,36,.04)",border:"rgba(251,191,36,.15)",tc:"#fbbf24",items:["â³ Ğ’Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ¾Ğº = Ğ¼Ñ–Ğ½Ñ–Ğ¼ÑƒĞ¼ 3Ã— Ñ‚Ñ€Ğ¸Ğ²Ğ°Ğ»Ñ–ÑÑ‚ÑŒ","ğŸ¤¿ ĞŸÑ–Ñ€Ğ½Ğ°Ğ² 1 Ñ…Ğ² â†’ Ğ²Ñ–Ğ´Ğ¿Ğ¾Ñ‡Ğ¸Ğ²Ğ°Ğ¹ 3 Ñ…Ğ² Ğ¼Ñ–Ğ½Ñ–Ğ¼ÑƒĞ¼","â¤ï¸ Ğ—Ğ°Ñ…Ğ¾Ğ´ÑŒ Ñƒ Ğ²Ğ¾Ğ´Ñƒ Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ Ğ¿Ñ€Ğ¸ Ğ¿ÑƒĞ»ÑŒÑÑ– < 85"]},
            ].map((s,si) => (
              <div key={si} style={{marginBottom:14}}>
                <div style={{fontSize:9,letterSpacing:3,color:"#475569",textTransform:"uppercase",marginBottom:7}}>{s.title}</div>
                {s.items.map((item,i) => (
                  <div key={i} style={{background:s.color,border:`1px solid ${s.border}`,borderRadius:9,padding:"9px 12px",marginBottom:5,fontSize:11,color:s.tc,lineHeight:1.5}}>{item}</div>
                ))}
              </div>
            ))}
          </div>
        )}
      </div>

      {/* â”€â”€ Edit session modal â”€â”€ */}
      {editW && (
        <div style={{position:"fixed",inset:0,zIndex:100,background:"rgba(0,0,0,.9)",backdropFilter:"blur(8px)",display:"flex",alignItems:"flex-end",justifyContent:"center"}} onClick={e=>{if(e.target===e.currentTarget)setEditW(null);}}>
          <div style={{background:"#0a1628",borderRadius:"18px 18px 0 0",border:"1px solid rgba(56,189,248,.2)",width:"100%",maxWidth:480,padding:20,maxHeight:"88vh",overflowY:"auto"}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
              <div style={{fontSize:15,color:"#f0f9ff"}}>Ğ¢Ğ¸Ğ¶Ğ´ĞµĞ½ÑŒ {editW.week} â€” Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚</div>
              <button onClick={()=>setEditW(null)} style={{background:"none",border:"none",color:"#475569",fontSize:18,cursor:"pointer"}}>âœ•</button>
            </div>
            <div style={{display:"flex",flexDirection:"column",gap:11}}>
              <div>
                <label style={{fontSize:10,color:"#64748b",display:"block",marginBottom:3}}>Ğ”Ğ°Ñ‚Ğ°</label>
                <input type="date" value={editW.date||""} onChange={e=>setEditW({...editW,date:e.target.value})}/>
              </div>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:9}}>
                <div><label style={{fontSize:10,color:"#64748b",display:"block",marginBottom:3}}>Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ĞºĞ° (Ñ…Ğ²:ÑĞµĞº)</label><input placeholder="2:30" value={editW.staticTime||""} onChange={e=>setEditW({...editW,staticTime:e.target.value})}/></div>
                <div><label style={{fontSize:10,color:"#64748b",display:"block",marginBottom:3}}>Ğ”Ğ¸Ğ½Ğ°Ğ¼Ñ–ĞºĞ° (Ğ¼)</label><input placeholder="50Ğ¼" value={editW.dynamicDist||""} onChange={e=>setEditW({...editW,dynamicDist:e.target.value})}/></div>
                <div><label style={{fontSize:10,color:"#64748b",display:"block",marginBottom:3}}>Avg HR</label><input placeholder="102" value={editW.avgHR||""} onChange={e=>setEditW({...editW,avgHR:e.target.value})}/></div>
                <div><label style={{fontSize:10,color:"#64748b",display:"block",marginBottom:3}}>Max HR</label><input placeholder="123" value={editW.maxHR||""} onChange={e=>setEditW({...editW,maxHR:e.target.value})}/></div>
              </div>
              <div>
                <label style={{fontSize:10,color:"#64748b",display:"block",marginBottom:3}}>Ğ¡Ğ°Ğ¼Ğ¾Ğ¿Ğ¾Ñ‡ÑƒÑ‚Ñ‚Ñ</label>
                <div style={{display:"flex",gap:4}}>
                  {["ğŸ˜« Ğ’Ğ°Ğ¶ĞºĞ¾","ğŸ˜ ĞĞ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾","ğŸ˜Š Ğ”Ğ¾Ğ±Ñ€Ğµ","ğŸ”¥ Ğ’Ñ–Ğ´Ğ¼Ñ–Ğ½Ğ½Ğ¾"].map(f => (
                    <button key={f} onClick={()=>setEditW({...editW,feeling:f})} style={{flex:1,padding:"6px 2px",borderRadius:7,fontSize:8,background:editW.feeling===f?"rgba(56,189,248,.15)":"rgba(255,255,255,.03)",border:editW.feeling===f?"1px solid rgba(56,189,248,.4)":"1px solid rgba(255,255,255,.07)",color:editW.feeling===f?"#38bdf8":"#64748b",cursor:"pointer"}}>{f}</button>
                  ))}
                </div>
              </div>
              <div>
                <label style={{fontSize:10,color:"#64748b",display:"block",marginBottom:3}}>ĞĞ¾Ñ‚Ğ°Ñ‚ĞºĞ¸</label>
                <textarea rows={3} placeholder="Ğ©Ğ¾ Ğ²Ğ´Ğ°Ğ»Ğ¾ÑÑŒ, Ñ‰Ğ¾ Ğ½Ñ–..." value={editW.notes||""} onChange={e=>setEditW({...editW,notes:e.target.value})} style={{resize:"none"}}/>
              </div>

              {/* FIT upload */}
              <div>
                <label style={{fontSize:10,color:"#64748b",display:"block",marginBottom:3}}>ğŸ“Š FIT Ñ„Ğ°Ğ¹Ğ» (Garmin Descend MK2S)</label>
                <input ref={fileRef} type="file" accept=".fit,.FIT" style={{display:"none"}} onChange={async e=>{const f=e.target.files?.[0]; if(f) await handleFitUpload(f,editW.week);}}/>
                <button className="wbtn" onClick={()=>fileRef.current?.click()} disabled={fitLoading} style={{width:"100%",padding:9,borderRadius:8,background:"rgba(56,189,248,.06)",border:"1px solid rgba(56,189,248,.2)",color:fitLoading?"#475569":"#38bdf8",fontSize:11,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:7}}>
                  {fitLoading
                    ? <><div style={{width:12,height:12,border:"2px solid #38bdf8",borderTopColor:"transparent",borderRadius:"50%",animation:"spin 1s linear infinite"}}/>ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³...</>
                    : fitData[editW.week] ? "âœ“ FIT Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ¾ â€” Ğ¾Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸" : "ğŸ“ Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ğ¸Ñ‚Ğ¸ .fit Ñ„Ğ°Ğ¹Ğ»"
                  }
                </button>
                {fitData[editW.week] && (
                  <div style={{marginTop:7,background:"rgba(56,189,248,.04)",borderRadius:8,padding:"8px 9px"}}>
                    <HRChart pts={fitData[editW.week].pts} color="#38bdf8"/>
                    <div style={{display:"flex",gap:7,marginTop:5,justifyContent:"center"}}>
                      {[{l:"Avg",v:fitData[editW.week].stats.avg},{l:"Max",v:fitData[editW.week].stats.max},{l:"Ğ¥Ğ²",v:fitData[editW.week].stats.dur}].map((s,i)=>(
                        <div key={i} style={{textAlign:"center"}}><div style={{fontSize:12,color:"#e2e8f0"}}>{s.v}</div><div style={{fontSize:8,color:"#475569"}}>{s.l}</div></div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </div>

            <div style={{display:"flex",gap:7,marginTop:14}}>
              <button onClick={()=>setEditW(null)} style={{flex:1,padding:11,borderRadius:11,background:"rgba(255,255,255,.03)",border:"1px solid rgba(255,255,255,.07)",color:"#64748b",cursor:"pointer"}}>Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸</button>
              <button onClick={()=>saveSession(editW.week,{...editW,completed:true})} style={{flex:2,padding:11,borderRadius:11,background:"linear-gradient(135deg,rgba(14,116,144,.4),rgba(30,58,138,.4))",border:"1px solid rgba(56,189,248,.3)",color:"#38bdf8",fontSize:13,cursor:"pointer"}}>âœ“ Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
</script>
</body>
</html>
